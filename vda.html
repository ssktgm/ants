<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配車調整アプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ドラッグ中の要素のスタイル */
        .opacity-50 { opacity: 0.5; }
        
        /* ドラッグ可能なアイテム */
        .draggable-item {
            cursor: move;
        }

        /* ★ドロップ先(移動)のハイライト */
        .members-dropzone.drop-target-move { 
            background-color: #EFF6FF; 
        }
        
        /* ★ドロップ先(入れ替え)のハイライト */
        .driver-dropzone.drop-target-swap, .draggable-item.drop-target-swap {
            border: 2px dashed #3B82F6; /* blue-500 */
            box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }
        
        /* ★ドロップ先(挿入)のハイライト */
        .draggable-item.drop-target-insert-before {
            border-top: 3px solid #3B82F6; /* blue-500 */
        }
        .draggable-item.drop-target-insert-after {
            border-bottom: 3px solid #3B82F6; /* blue-500 */
        }

        /* ★ドロップ先(定員オーバー) */
        .members-dropzone.drop-target-full { 
            background-color: #FEF2F2; 
        }
        
        /* details[open] summary のスタイル */
        details[open] > summary {
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        /* ファイル入力ボタンを隠す */
        #import-state-input, #import-master-input {
            display: none;
        }

        /* 可変グリッドレイアウトのためのCSS */
        .main-grid-layout {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* default: 1 col */
            gap: 1.5rem; /* gap-6 */
        }
        
        /* 結果表示用のグリッドレイアウト */
        .results-grid-layout {
            display: grid;
            grid-template-columns: repeat(1, minmax(0, 1fr)); /* default: 1 col */
            gap: 1rem; /* gap-4 */
        }

        @media (min-width: 1024px) { /* lg: breakpoint */
            .main-grid-layout {
                /* JSからこの変数を変更できるようにする */
                grid-template-columns: repeat(var(--layout-columns, 3), minmax(0, 1fr));
            }
            
            /* 結果表示用のグリッド（LG以上） */
            .results-grid-layout {
                grid-template-columns: repeat(var(--layout-columns, 3), minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">配車調整アプリ</h1>

        <!-- ファイル入出力ボタン -->
        <section class="mb-6 grid grid-cols-2 gap-2 md:w-1/2 lg:w-1/3">
            <!-- 状態 -->
            <button id="export-state-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200">
                状態を保存 (JSON)
            </button>
            <label for="import-state-input" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200 cursor-pointer text-center">
                状態を読み込む (JSON)
            </label>
            <input type="file" id="import-state-input" accept=".json">

            <!-- マスターデータ -->
            <button id="export-master-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200">
                マスターを保存 (JSON)
            </button>
            <label for="import-master-input" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-200 cursor-pointer text-center">
                マスターを読み込む (JSON)
            </label>
            <input type="file" id="import-master-input" accept=".json">
        </section>


        <!-- メッセージエリア -->
        <div id="message" class="hidden p-4 mb-4 border rounded-lg" role="alert">
            <span id="message-text"></span>
            <button id="message-close" type="button" class="float-right font-bold text-lg leading-none">&times;</button>
        </div>

        <!-- メインコンテンツグリッド -->
        <div id="main-content" class="main-grid-layout">

            <!-- ステップ 1: 参加者選択 -->
            <section>
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-700">1. 参加者を選択</h2>
                    <button id="toggle-details-button" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-1 px-3 rounded-lg text-sm transition duration-200">
                        すべて開く
                    </button>
                </div>
                <div id="participant-list" class="space-y-2 h-[600px] overflow-y-auto bg-white p-4 rounded-lg shadow">
                    <!-- JSで描画 -->
                </div>
            </section>

            <!-- ステップ 2: 車選択 -->
            <section>
                <h2 class="text-xl font-semibold text-gray-700 mb-3">2. 車とドライバーを選択</h2>
                <div id="car-list" class="space-y-3 h-[600px] overflow-y-auto bg-white p-4 rounded-lg shadow">
                    <!-- JSで描画 -->
                </div>
            </section>

            <!-- ステップ 3 & 4: 別便除外 と 実行ボタン -->
            <section>
                <h2 class="text-xl font-semibold text-gray-700 mb-3">3. 別便の人を除外</h2>
                <div id="exclusion-list" class="space-y-2 h-[488px] overflow-y-auto bg-white p-4 rounded-lg shadow min-h-[50px]">
                    <!-- JSで描画 -->
                </div>
                
                <div class="mt-6 text-center">
                    <button id="assign-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-10 rounded-lg shadow-lg transition duration-200 ease-in-out transform hover:scale-105">
                        4. 割り当て実行
                    </button>
                </div>
            </section>

            <!-- ステップ 5: 割り当て結果 -->
            <section id="results-section"> 
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xl font-semibold text-gray-700">5. 割り当て結果 (ドラッグ＆ドロップで調整可能)</h2>
                    <button id="show-text-output-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-lg shadow text-sm transition duration-200">
                        テキスト出力
                    </button>
                </div>

                <!-- テキスト出力エリア -->
                <div id="text-output-container" class="mb-4 hidden">
                    <textarea id="text-output" rows="5" class="w-full p-2 border rounded-lg font-mono text-sm bg-gray-50" readonly></textarea>
                    <button id="copy-text-output-button" class="mt-2 bg-gray-400 hover:bg-gray-500 text-white py-1 px-3 rounded text-sm">
                        コピー
                    </button>
                </div>

                <div id="results" class="results-grid-layout"> 
                    <p id="results-placeholder" class="text-gray-500 text-sm bg-white p-4 rounded-lg shadow min-h-[50px]">ステップ4の「割り当て実行」を押してください。</p>
                </div>
            </section>

        </div> <!-- main-content 閉じタグ -->

    </div>

    <script type="module">
        // --- レイアウト列数の定義 ---
        const LAYOUT_COLUMNS = 3; 

        // --- 事前定義データ ---
        
        let FAMILIES = [
            {
                familyName: '小高家', 
                members: [
                    { id: 'p1', name: '斗愛', type: '選手', isFlagTarget: true, data: { grade: '5年', school: '東小', other: '', memo: '' } },
                    { id: 'p2', name: '小高監督', type: '保護者', data: { memo: '' } },
                    { id: 'p3', name: '小高母', type: '保護者', data: { memo: '' } },
                    { id: 'p22', name: '愛之佑', type: '選手', isFlagTarget: true, data: { grade: '3年', school: '東小', other: '', memo: '' } } 
                ]
            },
            {
                familyName: '難波家',
                members: [
                    { id: 'p4', name: '諒成', type: '選手', isFlagTarget: true, data: { grade: '5年', school: 'x小', other: '', memo: '' } },
                    { id: 'p5', name: '難波父', type: '保護者', data: { memo: '' } }
                ]
            },
            {
                familyName: '浪川家',
                members: [
                    { id: 'p6', name: '長政', type: '選手', isFlagTarget: true, data: { grade: '5年', school: '小金小', other: '', memo: '' } },
                    { id: 'p7', name: '浪川父', type: '保護者', data: { memo: '' } },
                    { id: 'p8', name: '浪川母', type: '保護者', data: { memo: '' } }
                ]
            },
            {
                familyName: '高橋家',
                members: [
                    { id: 'p9', name: '湊多', type: '選手', isFlagTarget: true, data: { grade: '5年', school: '東小', other: '', memo: '' } }
                ]
            },
            {
                familyName: '山田家',
                members: [
                    { id: 'p10', name: '颯真', type: '選手', isFlagTarget: true, data: { grade: '4年', school: '小金小', other: '', memo: '' } },
                    { id: 'p11', name: '山田父', type: '保護者', data: { memo: '' } },
                    { id: 'p12', name: '山田母', type: '保護者', data: { memo: '' } }
                ]
            },
            {
                familyName: '菱沼家',
                members: [
                    { id: 'p13', name: '颯介', type: '選手', isFlagTarget: true, data: { grade: '4年', school: '小金小', other: '', memo: '' } },
                    { id: 'p14', name: '菱沼父', type: '保護者', data: { memo: '' } },
                    { id: 'p15', name: '菱沼母', type: '保護者', data: { memo: '' } },
                    { id: 'p16', name: 'つぐみ', type: '兄弟', isFlagTarget: false, data: { grade: '2年', school: '小金小', other: '', memo: '' } }
                ]
            },
            {
                familyName: '小野家',
                members: [
                    { id: 'p17', name: '暁人', type: '選手', isFlagTarget: true, data: { grade: '4年', school: '小金小', other: '', memo: '' } },
                    { id: 'p18', name: '小野母', type: '保護者', data: { memo: '' } },
                    { id: 'p19', name: 'ななか', type: '兄弟', isFlagTarget: true, data: { grade: '2年', school: '小金小', other: '', memo: '' } }
                ]
            },
            {
                familyName: '津村家',
                members: [
                    { id: 'p20', name: '一樹', type: '選手', isFlagTarget: true, data: { grade: '4年', school: '東小', other: '', memo: '' } },
                    { id: 'p21', name: '津村父', type: '保護者', data: { memo: '' } }
                ]
            },
            {
                familyName: '浅野家',
                members: [
                    { id: 'p23', name: '泰地', type: '選手', isFlagTarget: true, data: { grade: '3年', school: '小金小', other: '', memo: '' } },
                    { id: 'p24', name: '浅野父', type: '保護者', data: { memo: '' } },
                    { id: 'p25', name: '浅野母', type: '保護者', data: { memo: '' } }
                ]
            },
            {
                familyName: '近藤家', 
                members: [
                    { id: 'p26', name: '謙成', type: '選手', isFlagTarget: true, data: { grade: '3年', school: '八木南小', other: '', memo: '' } },
                    { id: 'p44', name: '茉莉', type: '選手', isFlagTarget: true, data: { grade: '1年', school: '八木南小', other: '', memo: '' } } ,
                    { id: 'p27', name: '近藤父', type: '保護者', data: { memo: '' } },
                    { id: 'p28', name: '近藤母', type: '保護者', data: { memo: '' } },
                    { id: 'p29', name: 'おうすけ', type: '兄弟', isFlagTarget: true, data: { grade: '', school: '', other: '', memo: '' } }
                ]
            },
            {
                familyName: '知野見家',
                members: [
                    { id: 'p30', name: '怜央', type: '選手', isFlagTarget: true, data: { grade: '3年', school: '小金小', other: '', memo: '' } },
                    { id: 'p31', name: '知野見父', type: '保護者', data: { memo: '' } },
                    { id: 'p32', name: '知野見母', type: '保護者', data: { memo: '' } },
                    { id: 'p33', name: 'ゆな', type: '兄弟', isFlagTarget: true, data: { grade: '', school: '', other: '', memo: '' } }
                ]
            },
            {
                familyName: '藤山家',
                members: [
                    { id: 'p34', name: '琉杜', type: '選手', isFlagTarget: true, data: { grade: '3年', school: '小金小', other: '', memo: '' } },
                    { id: 'p35', name: '藤山父', type: '保護者', data: { memo: '' } },
                    { id: 'p36', name: '藤山母', type: '保護者', data: { memo: '' } }
                ]
            },
            {
                familyName: '小河原家',
                members: [
                    { id: 'p37', name: '維', type: '選手', isFlagTarget: true, data: { grade: '3年', school: '小金小', other: '', memo: '' } }, // 画像では 3年 A/B
                    { id: 'p38', name: '小河原父', type: '保護者', data: { memo: '' } },
                    { id: 'p39', name: '小河原母', type: '保護者', data: { memo: '' } }
                ]
            },
            {
                familyName: '古川家',
                members: [
                    { id: 'p40', name: '峻丞', type: '選手', isFlagTarget: true, data: { grade: '2年', school: '新松戸南小', other: '', memo: '' } },
                    { id: 'p41', name: '古川父', type: '保護者', data: { memo: '' } }
                ]
            },
            {
                familyName: '坪井家',
                members: [
                    { id: 'p42', name: '雄也', type: '選手', isFlagTarget: true, data: { grade: '1年', school: '東小', other: '', memo: '' } },
                    { id: 'p43', name: '坪井父', type: '保護者', data: { memo: '' } }
                ]
            },
            {
                familyName: 'スタッフ・個人', // ★コーチ等、家族に属さない個人用
                members: [
                    { id: 'p94', name: '渡邉会長', type: 'その他', data: { memo: '' } },
                    { id: 'p99', name: '木村代表', type: 'その他', data: { memo: '' } },
                    { id: 'p98', name: '吉田さん', type: 'その他', data: { memo: '' } },
                    { id: 'p97', name: '前田さん', type: 'その他', data: { memo: '' } },
                    { id: 'p96', name: '中田さん', type: 'その他', data: { memo: '' } },
                    { id: 'p95', name: '渡辺さん', type: 'その他', data: { memo: '' } },
                ]
            }
        ];

        let AVAILABLE_CARS_INFO = [
            { id: 'c1', name: '小高カー', familyName: '小高家', baseCapacity: 6 }, 
            { id: 'c2', name: '難波カー', familyName: '難波家', baseCapacity: 7 },
            { id: 'c3', name: '浪川カー①', familyName: '浪川家', baseCapacity: 6 },
            { id: 'c4', name: '浪川カー②', familyName: '浪川家', baseCapacity: 5 },
            { id: 'c5', name: '山田カー①', familyName: '山田家', baseCapacity: 7 },
            { id: 'c6', name: '山田カー②', familyName: '山田家', baseCapacity: 5 },
            { id: 'c7', name: '菱沼カー', familyName: '菱沼家', baseCapacity: 6 },
            { id: 'c8', name: '小野カー', familyName: '小野家', baseCapacity: 8 },
            { id: 'c9', name: '浅野カー', familyName: '浅野家', baseCapacity: 8 },
            { id: 'c10', name: '近藤カー', familyName: '近藤家', baseCapacity: 6 }, 
            { id: 'c11', name: '知野見カー', familyName: '知野見家', baseCapacity: 7 }, // ※画像に定員記載なし、仮に7
            { id: 'c12', name: '藤山カー', familyName: '藤山家', baseCapacity: 4 },
            { id: 'c13', name: '小河原カー①', familyName: '小河原家', baseCapacity: 4 },
            { id: 'c14', name: '小河原カー②', familyName: '小河原家', baseCapacity: 4 },
            { id: 'c15', name: '古川カー', familyName: '古川家', baseCapacity: 8 },
            { id: 'c16', name: 'コーチカー', familyName: 'スタッフ・個人', baseCapacity: 5 } // ★コーチ用の車（仮）
        ];

        let ALL_PARTICIPANTS_FLAT = FAMILIES.flatMap(f => f.members);


        // --- 状態変数 ---
        let selectedParticipantIds = new Set();
        let selectedCarIds = new Set();
        let selectedDrivers = new Map(); // carId -> driverId
        let selectedLuggage = new Set(); // carId
        let excludedParticipantIds = new Set();
        let participantData = new Map(); // participantId -> { grade, school, other, memo }
        let currentAssignments = []; // 割り当て結果: { car..., driver: {p...}, members: [{p...}] }
        
        // ドラッグ＆ドロップ用一時変数
        let dragTargetId = null; 
        let dragSourceCarId = null; 
        let dragIsDriver = false;
        // ★ドロップ操作の種類を保持
        let currentDropMode = null; // 'swap', 'insert-before', 'insert-after', 'move-to-end'
        let currentDropTargetId = null; // 挿入/スワップ対象のID


        // --- DOM参照 ---
        const participantListEl = document.getElementById('participant-list');
        const carListEl = document.getElementById('car-list');
        const exclusionListEl = document.getElementById('exclusion-list');
        const resultsEl = document.getElementById('results');
        const assignButton = document.getElementById('assign-button');
        const messageContainer = document.getElementById('message');
        const messageText = document.getElementById('message-text');
        const messageClose = document.getElementById('message-close');
        const exportButton = document.getElementById('export-state-button');
        const importInput = document.getElementById('import-state-input');
        const showTextOutputButton = document.getElementById('show-text-output-button');
        const textOutputContainer = document.getElementById('text-output-container');
        const textOutputEl = document.getElementById('text-output');
        const copyTextOutputButton = document.getElementById('copy-text-output-button');
        const toggleDetailsButton = document.getElementById('toggle-details-button');
        
        const exportMasterButton = document.getElementById('export-master-button');
        const importMasterInput = document.getElementById('import-master-input');


        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            document.documentElement.style.setProperty('--layout-columns', LAYOUT_COLUMNS);
            
            const resultsSection = document.getElementById('results-section');
            function updateLayouts() { 
                const placeholder = document.getElementById('results-placeholder');
                
                if (window.innerWidth >= 1024) { // lg breakpoint
                    resultsSection.style.gridColumn = `span ${LAYOUT_COLUMNS}`;
                    if (placeholder) {
                        placeholder.style.gridColumn = `span ${LAYOUT_COLUMNS}`;
                    }
                } else {
                    resultsSection.style.gridColumn = 'auto';
                    if (placeholder) {
                        placeholder.style.gridColumn = 'auto';
                    }
                }
            }
            updateLayouts();
            window.addEventListener('resize', updateLayouts); 

            initializeParticipantData(); 
            renderParticipantList();
            renderCarList();
            
            participantListEl.addEventListener('change', handleParticipantChange);
            participantListEl.addEventListener('input', handleParticipantDataInput); 
            carListEl.addEventListener('change', handleCarChange);
            exclusionListEl.addEventListener('change', handleExclusionChange);
            assignButton.addEventListener('click', handleAssignment);
            messageClose.addEventListener('click', hideMessage);
            resultsEl.addEventListener('dragstart', handleDragStart);
            resultsEl.addEventListener('dragover', handleDragOver);
            resultsEl.addEventListener('drop', handleDrop);
            resultsEl.addEventListener('dragend', handleDragEnd);
            exportButton.addEventListener('click', handleExportState);
            importInput.addEventListener('change', handleImportState);
            showTextOutputButton.addEventListener('click', handleShowTextOutput);
            copyTextOutputButton.addEventListener('click', handleCopyTextOutput);
            toggleDetailsButton.addEventListener('click', handleToggleDetails);

            exportMasterButton.addEventListener('click', handleExportMasterData);
            importMasterInput.addEventListener('change', handleImportMasterData);
        });

        // ★参加者データ（備考含む）を初期化
        function initializeParticipantData() {
            participantData.clear(); 
            FAMILIES.forEach(family => {
                family.members.forEach(member => {
                    // メモデータは全員、フラグデータは対象者のみ
                    const defaultData = { 
                        grade: '', school: '', other: '', 
                        ...member.data // memo: '' もここで上書き
                    };
                    
                    if (!member.isFlagTarget) {
                        defaultData.grade = '';
                        defaultData.school = '';
                        defaultData.other = '';
                    }
                    participantData.set(member.id, defaultData);
                });
            });
        }

        // ステップ1: 参加者リストを描画
        function renderParticipantList() {
            participantListEl.innerHTML = '';
            FAMILIES.forEach(family => {
                const details = document.createElement('details');
                details.className = 'bg-gray-50 rounded border';
                
                const summary = document.createElement('summary');
                summary.className = 'p-3 font-semibold cursor-pointer select-none';
                summary.textContent = family.familyName;
                
                const memberList = document.createElement('div');
                memberList.className = 'p-3 border-t border-gray-200 space-y-3';

                family.members.forEach(p => {
                    const isChecked = selectedParticipantIds.has(p.id);
                    const wrapper = document.createElement('div');
                    wrapper.className = 'ml-4';

                    // 参加者名とチェックボックス
                    const participantDiv = document.createElement('div');
                    participantDiv.className = 'flex items-center';
                    participantDiv.innerHTML = `
                        <input type="checkbox" id="p-${p.id}" data-id="${p.id}" data-action="select-participant" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isChecked ? 'checked' : ''}>
                        <label for="p-${p.id}" class="text-gray-700">${p.name} (${p.type})</label>
                    `;
                    wrapper.appendChild(participantDiv);
                    
                    // データ入力欄
                    const data = participantData.get(p.id) || { grade: '', school: '', other: '', memo: '' };
                    const dataDiv = document.createElement('div');
                    dataDiv.id = `data-inputs-${p.id}`; 
                    dataDiv.className = `ml-8 mt-1.5 grid grid-cols-4 gap-2 ${isChecked ? '' : 'opacity-50'}`;
                    
                    if (p.isFlagTarget) {
                        dataDiv.innerHTML = `
                            <input type="text" data-id="${p.id}" data-type="grade" value="${data.grade || ''}" placeholder="学年" class="w-full text-sm p-1 border rounded shadow-sm" ${isChecked ? '' : 'disabled'}>
                            <input type="text" data-id="${p.id}" data-type="school" value="${data.school || ''}" placeholder="学校" class="w-full text-sm p-1 border rounded shadow-sm" ${isChecked ? '' : 'disabled'}>
                            <input type="text" data-id="${p.id}" data-type="other" value="${data.other || ''}" placeholder="その他" class="w-full text-sm p-1 border rounded shadow-sm" ${isChecked ? '' : 'disabled'}>
                            <input type="text" data-id="${p.id}" data-type="memo" value="${data.memo || ''}" placeholder="備考" class="w-full text-sm p-1 border rounded shadow-sm" ${isChecked ? '' : 'disabled'}>
                        `;
                    } else {
                        // isFlagTarget: false の場合は備考欄のみ
                        dataDiv.innerHTML = `
                            <div class="col-span-3"></div> <!-- 空白 -->
                            <input type="text" data-id="${p.id}" data-type="memo" value="${data.memo || ''}" placeholder="備考" class="w-full text-sm p-1 border rounded shadow-sm" ${isChecked ? '' : 'disabled'}>
                        `;
                    }
                    wrapper.appendChild(dataDiv);
                    memberList.appendChild(wrapper);
                });
                details.appendChild(summary);
                details.appendChild(memberList);
                participantListEl.appendChild(details);
            });
        }

        // ステップ2: 車リストを描画
        function renderCarList() {
            carListEl.innerHTML = '';
            AVAILABLE_CARS_INFO.forEach(car => {
                const family = FAMILIES.find(f => f.familyName === car.familyName);
                const driverOptions = family ? family.members : ALL_PARTICIPANTS_FLAT; 
                const isChecked = selectedCarIds.has(car.id);
                const driverId = selectedDrivers.get(car.id) || '';
                const hasLuggage = selectedLuggage.has(car.id);
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded border p-3';
                div.dataset.carId = car.id;
                div.innerHTML = `
                    <div class="flex items-center">
                        <input type="checkbox" id="c-${car.id}" data-id="${car.id}" data-action="select-car" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${isChecked ? 'checked' : ''}>
                        <label for="c-${car.id}" class="font-semibold">${car.name} (定員${car.baseCapacity}名)</label>
                    </div>
                    <div id="car-options-${car.id}" class="ml-8 mt-3 space-y-3 ${isChecked ? '' : 'hidden'}">
                        <div>
                            <label for="driver-${car.id}" class="block text-sm font-medium text-gray-700">ドライバー:</label>
                            <select id="driver-${car.id}" data-action="select-driver" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="">選択してください</option>
                                ${driverOptions.map(p => `<option value="${p.id}" ${driverId === p.id ? 'selected' : ''}>${p.name} (${p.type})</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="luggage-${car.id}" data-action="select-luggage" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${hasLuggage ? 'checked' : ''}>
                            <label for="luggage-${car.id}" class="text-sm text-gray-700">荷物あり (乗客定員1名)</label>
                        </div>
                    </div>
                `;
                carListEl.appendChild(div);
            });
        }

        // ステップ3: 除外リストを描画
        function renderExclusionList() {
            exclusionListEl.innerHTML = '';
            const participants = ALL_PARTICIPANTS_FLAT.filter(p => selectedParticipantIds.has(p.id));
            if (participants.length === 0) {
                exclusionListEl.innerHTML = '<p class="text-gray-500 text-sm">ステップ1で参加者を選択してください。</p>';
                return;
            }
            participants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="ex-${p.id}" data-id="${p.id}" data-action="exclude-participant" class="mr-3 rounded border-gray-300 text-blue-600 focus:ring-blue-500" ${excludedParticipantIds.has(p.id) ? 'checked' : ''}>
                    <label for="ex-${p.id}" class="text-gray-700">${p.name} (${p.type})</label>
                `;
                exclusionListEl.appendChild(div);
            });
        }

        // ★ステップ5: 割り当て結果を描画 (ドライバーと別便対応)
        function renderResults(assignments) {
            resultsEl.innerHTML = '';
            
            if (assignments.length === 0) {
                resultsEl.innerHTML = `<p id="results-placeholder" class="text-gray-500 text-sm bg-white p-4 rounded-lg shadow min-h-[50px]">ステップ4の「割り当て実行」を押してください。</p>`;
                const placeholder = document.getElementById('results-placeholder');
                if (placeholder) {
                     if (window.innerWidth >= 1024) { 
                        placeholder.style.gridColumn = `span ${LAYOUT_COLUMNS}`;
                    } else {
                        placeholder.style.gridColumn = 'auto';
                    }
                }
                return;
            }

            assignments.forEach(car => {
                const card = document.createElement('div');
                card.id = `car-result-${car.id}`;
                card.dataset.carId = car.id; 
                card.className = 'bg-white border rounded-lg shadow-md car-dropzone';
                
                let headerHtml = '';
                let driverHtml = '';
                
                // 「別便カー」の特別処理
                if (car.id === 'excluded-car') {
                    headerHtml = `
                        <div class="p-4 border-b bg-gray-100">
                            <h4 class="font-bold text-lg text-gray-700">${car.name}</h4>
                            <p class="text-sm text-gray-600">乗客: ${car.members.length}名</p>
                        </div>`;
                } else {
                    // 通常の車
                    const vacancy = car.capacity - car.members.length;
                    const luggageInfo = car.hasLuggage ? ' (荷物あり)' : '';
                    headerHtml = `
                        <div class="p-4 border-b">
                            <h4 class="font-bold text-lg">${car.name} ${luggageInfo}</h4>
                            <p class="text-sm font-medium ${vacancy < 0 ? 'text-red-600' : 'text-blue-600'}">
                                乗客: ${car.members.length}名 / 定員 ${car.capacity}名 (空き ${vacancy}名)
                            </p>
                        </div>`;
                    
                    // ドライバー欄
                    const d = car.driver;
                    if (d) {
                        const memo = participantData.get(d.id)?.memo || '';
                        driverHtml = `
                        <div id="driver-dropzone-${car.id}" class="p-4 border-b driver-dropzone">
                            <li id="p-result-${d.id}" data-participant-id="${d.id}" data-is-driver="true" draggable="true" 
                                class="p-2 bg-blue-100 rounded shadow-sm flex justify-between items-center draggable-item">
                                <div>
                                    <span class="font-semibold text-blue-800">[D] ${d.name} (${d.type})</span>
                                    ${memo ? `<span class="text-xs text-blue-600 ml-2">(${memo})</span>` : ''}
                                </div>
                            </li>
                        </div>`;
                    } else {
                         driverHtml = `
                         <div id="driver-dropzone-${car.id}" class="p-4 border-b driver-dropzone min-h-[50px] bg-red-50">
                            <p class="text-red-700 text-sm">ドライバーがいません</p>
                         </div>`;
                    }
                }
                
                // 乗客リスト
                const membersHtml = car.members.map(p => {
                    const memo = participantData.get(p.id)?.memo || '';
                    return `
                    <li id="p-result-${p.id}" data-participant-id="${p.id}" data-is-driver="false" draggable="true" 
                        class="p-2 bg-gray-100 rounded shadow-sm flex justify-between items-center draggable-item">
                        <div>
                            <span>${p.name} (${p.type})</span>
                            ${memo ? `<span class="text-xs text-gray-500 ml-2">(${memo})</span>` : ''}
                        </div>
                        <span class="text-xs text-gray-400">${[p.flags?.grade, p.flags?.school, p.flags?.other].filter(Boolean).join(' ')}</span>
                    </li>`;
                }).join('');

                card.innerHTML = `
                    ${headerHtml}
                    ${driverHtml}
                    <ul id="members-dropzone-${car.id}" class="p-4 space-y-2 min-h-[50px] members-dropzone">
                        ${membersHtml}
                    </ul>
                `;
                resultsEl.appendChild(card);
            });
        }


        // --- ドラッグ＆ドロップ ---
        
        // ★全てのハイライトをクリア
        function clearDragOverHighlights() {
            document.querySelectorAll('.draggable-item').forEach(el => {
                el.classList.remove('drop-target-swap', 'drop-target-insert-before', 'drop-target-insert-after');
            });
            document.querySelectorAll('.driver-dropzone').forEach(el => {
                el.classList.remove('drop-target-swap');
            });
            document.querySelectorAll('.members-dropzone').forEach(el => {
                el.classList.remove('drop-target-move', 'drop-target-full');
            });
        }

        function handleDragStart(e) {
            if (e.target.classList.contains('draggable-item')) {
                dragTargetId = e.target.dataset.participantId;
                dragSourceCarId = e.target.closest('.car-dropzone').dataset.carId;
                dragIsDriver = e.target.dataset.isDriver === 'true';
                e.dataTransfer.effectAllowed = 'move';
                e.target.classList.add('opacity-50');
                
                // リセット
                currentDropMode = null;
                currentDropTargetId = null;
            }
        }

        // ★並び替え対応
        function handleDragOver(e) {
            e.preventDefault(); 
            const dropzone = e.target.closest('.car-dropzone');
            if (!dropzone) return;

            const targetItem = e.target.closest('.draggable-item');
            const targetDriverZone = e.target.closest('.driver-dropzone');
            const targetMembersZone = e.target.closest('.members-dropzone');
            
            clearDragOverHighlights(); 
            currentDropMode = null;
            currentDropTargetId = null;
            
            // --- ホバー対象の判定 ---

            // 1. アイテム(li) の上
            if (targetItem) {
                const targetIsDriver = targetItem.dataset.isDriver === 'true';
                
                // 1a. ドライバーの上 (またはドライバーが乗客の上) -> 入れ替え
                if (targetIsDriver || dragIsDriver) {
                    targetItem.classList.add('drop-target-swap');
                    currentDropMode = 'swap';
                    currentDropTargetId = targetItem.dataset.participantId;
                } 
                // 1b. 乗客の上 -> 挿入
                else {
                    const rect = targetItem.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;
                    
                    if (e.clientY < midY) {
                        targetItem.classList.add('drop-target-insert-before');
                        currentDropMode = 'insert-before';
                    } else {
                        targetItem.classList.add('drop-target-insert-after');
                        currentDropMode = 'insert-after';
                    }
                    currentDropTargetId = targetItem.dataset.participantId;
                }
            }
            // 2. ドライバーゾーン(div) の上 -> 入れ替え
            else if (targetDriverZone) {
                targetDriverZone.classList.add('drop-target-swap');
                currentDropMode = 'swap';
                // ターゲットはゾーンが属する車のドライバー
                const carId = targetDriverZone.closest('.car-dropzone').dataset.carId;
                currentDropTargetId = currentAssignments.find(c => c.id === carId)?.driver?.id || null;
            } 
            // 3. 乗客ゾーン(ul) の背景の上 -> 末尾に移動
            else if (targetMembersZone) {
                currentDropMode = 'move-to-end';
                
                const targetCarId = dropzone.dataset.carId;
                if (targetCarId === dragSourceCarId && !dragIsDriver) {
                     // 同じ車の乗客ゾーンへの移動はハイライト不要
                } else {
                    const targetCar = currentAssignments.find(c => c.id === targetCarId);
                    if (targetCar && targetCar.id !== 'excluded-car' && targetCar.members.length >= targetCar.capacity) {
                        targetMembersZone.classList.add('drop-target-full');
                    } else {
                        targetMembersZone.classList.add('drop-target-move');
                    }
                }
            }
        }

        // 車の空き状況UIを更新
        function updateCarVacancyUI(carId) {
            const car = currentAssignments.find(c => c.id === carId);
            if (!car || car.id === 'excluded-car' || !car.element) return;
            
            const vacancy = car.capacity - car.members.length;
            const pEl = car.element.querySelector('p.font-medium');
            if (pEl) {
                pEl.textContent = `乗客: ${car.members.length}名 / 定員 ${car.capacity}名 (空き ${vacancy}名)`;
                pEl.classList.toggle('text-red-600', vacancy < 0);
                pEl.classList.toggle('text-blue-600', vacancy >= 0);
            }
        }
        
        // 参加者オブジェクトをデータから見つけるヘルパー
        function findAndRemoveParticipant(carId, pId, isDriver) {
            const car = currentAssignments.find(c => c.id === carId);
            if (!car) return null;
            
            if (isDriver) {
                if (car.driver && car.driver.id === pId) {
                    const p = car.driver;
                    car.driver = null; // ドライバーを削除
                    return p;
                }
            } else {
                const index = car.members.findIndex(p => p.id === pId);
                if (index > -1) {
                    return car.members.splice(index, 1)[0]; // 乗客を削除
                }
            }
            return null;
        }

        // ★並び替え対応
        function handleDrop(e) {
            e.preventDefault();
            clearDragOverHighlights(); 
            
            const targetCarId = e.target.closest('.car-dropzone')?.dataset.carId;
            if (!targetCarId || !dragTargetId) return;

            const sourceCar = currentAssignments.find(c => c.id === dragSourceCarId);
            const targetCar = currentAssignments.find(c => c.id === targetCarId);

            if (!sourceCar || !targetCar) return;
            
            // ドラッグ元の参加者データを取得＆削除
            const sourceParticipant = findAndRemoveParticipant(dragSourceCarId, dragTargetId, dragIsDriver);
            if (!sourceParticipant) return; // 予期せぬエラー

            let operationDone = false;
            
            // --- 1. 入れ替え (Swap) ---
            if (currentDropMode === 'swap' && currentDropTargetId) {
                const targetIsDriver = (targetCar.driver && targetCar.driver.id === currentDropTargetId);
                const targetParticipant = findAndRemoveParticipant(targetCarId, currentDropTargetId, targetIsDriver);
                
                if (targetParticipant) {
                    // 1a. source を target の位置に入れる
                    if (targetIsDriver) targetCar.driver = sourceParticipant;
                    else targetCar.members.push(sourceParticipant); // スワップ時は乗客リストの末尾でOK
                    
                    // 1b. target を source の位置に入れる
                    if (dragIsDriver) sourceCar.driver = targetParticipant;
                    else sourceCar.members.push(targetParticipant);
                    
                    operationDone = true;
                }
            }
            // --- 2. 挿入 (Insert Before / After) ---
            else if ((currentDropMode === 'insert-before' || currentDropMode === 'insert-after') && currentDropTargetId) {
                // 定員チェック
                if (targetCar.id !== 'excluded-car' && targetCarId !== dragSourceCarId && targetCar.members.length >= targetCar.capacity) {
                     showMessage(`エラー: ${targetCar.name} は定員オーバーです。`, 'error');
                } else {
                    const targetIndex = targetCar.members.findIndex(p => p.id === currentDropTargetId);
                    if (targetIndex > -1) {
                        const insertIndex = (currentDropMode === 'insert-before') ? targetIndex : targetIndex + 1;
                        targetCar.members.splice(insertIndex, 0, sourceParticipant);
                        operationDone = true;
                        hideMessage();
                    }
                }
            }
            // --- 3. 末尾へ移動 (Move to End) ---
            else if (currentDropMode === 'move-to-end') {
                if (targetCarId === dragSourceCarId && !dragIsDriver) {
                    // 同じ車の乗客ゾーン -> 元の位置（末尾）に戻す
                    sourceCar.members.push(sourceParticipant); 
                    operationDone = true;
                } else {
                    // 定員チェック
                    if (targetCar.id !== 'excluded-car' && targetCar.members.length >= targetCar.capacity) {
                        showMessage(`エラー: ${targetCar.name} は定員オーバーです。`, 'error');
                    } else {
                        targetCar.members.push(sourceParticipant);
                        operationDone = true;
                        hideMessage();
                    }
                }
            }

            // --- 4. 操作失敗/キャンセル -> 元に戻す ---
            if (!operationDone) {
                if (dragIsDriver) sourceCar.driver = sourceParticipant;
                else sourceCar.members.push(sourceParticipant);
            }
            
            // --- 5. ドライバー昇格処理 (sourceCar) ---
            if (operationDone && dragIsDriver && !sourceCar.driver && sourceCar.id !== 'excluded-car') {
                 if (sourceCar.members.length > 0) {
                    sourceCar.driver = sourceCar.members.splice(0, 1)[0];
                }
            }
            
            // --- 6. ドライバー降格処理 (targetCar) ---
            // ※乗客をドライバーゾーンにSwapした場合は、元ドライバーが乗客に降格（Swap処理で完了済）
            // ※乗客を乗客ゾーンにInsert/Moveした場合は、targetCarのドライバーは不変

            // 全体を再描画
            renderResults(currentAssignments);
            updateCarVacancyUI(dragSourceCarId);
            updateCarVacancyUI(targetCarId);
        }

        function handleDragEnd(e) {
            if (dragTargetId) {
                const el = document.getElementById(`p-result-${dragTargetId}`);
                if (el) el.classList.remove('opacity-50');
            }
            clearDragOverHighlights();
            dragTargetId = null;
            dragSourceCarId = null;
            dragIsDriver = false;
            currentDropMode = null;
            currentDropTargetId = null;
        }


        // --- イベントハンドラ ---

        function handleParticipantChange(e) {
            const target = e.target;
            if (target.type === 'checkbox' && target.dataset.action === 'select-participant') {
                const id = target.dataset.id;
                const dataEl = document.getElementById(`data-inputs-${id}`); 
                
                if (target.checked) {
                    selectedParticipantIds.add(id);
                    if (dataEl) {
                        dataEl.classList.remove('opacity-50');
                        dataEl.querySelectorAll('input, textarea').forEach(input => input.disabled = false);
                    }
                } else {
                    selectedParticipantIds.delete(id);
                    if (dataEl) {
                        dataEl.classList.add('opacity-50');
                        dataEl.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                    }
                    if (excludedParticipantIds.has(id)) {
                        excludedParticipantIds.delete(id);
                    }
                }
                renderExclusionList();
            }
        }

        // ★データ入力のハンドラ (備考含む)
        function handleParticipantDataInput(e) {
            const target = e.target;
            if (target.dataset.id && target.dataset.type) {
                const id = target.dataset.id;
                const type = target.dataset.type;
                const value = target.value;
                
                const data = participantData.get(id) || { grade: '', school: '', other: '', memo: '' };
                data[type] = value;
                participantData.set(id, data);
            }
        }

        // 車選択のハンドラ
        function handleCarChange(e) {
// ... (既存の関数) ...
            const target = e.target;
            const carId = target.closest('[data-car-id]')?.dataset.carId;
            if (!carId) return;

            const action = target.dataset.action;

            if (action === 'select-car') {
// ... (既存の関数) ...
                if (target.checked) {
                    selectedCarIds.add(carId);
                    document.getElementById(`car-options-${carId}`).classList.remove('hidden');
                } else {
                    selectedCarIds.delete(carId);
// ... (既存の関数) ...
                    selectedDrivers.delete(carId);
                    selectedLuggage.delete(carId);
                    document.getElementById(`car-options-${carId}`).classList.add('hidden');
                    document.getElementById(`driver-${carId}`).value = '';
                }
            } else if (action === 'select-driver') {
// ... (既存の関数) ...
                if (target.value) {
                    selectedDrivers.set(carId, target.value);
                } else {
                    selectedDrivers.delete(carId);
                }
            } else if (action === 'select-luggage') {
// ... (既存の関数) ...
                if (target.checked) {
                    selectedLuggage.add(carId);
                } else {
                    selectedLuggage.delete(carId);
// ... (既存の関数) ...
                }
            }
        }

        // 除外者選択のハンドラ
        function handleExclusionChange(e) {
// ... (既存の関数) ...
            const target = e.target;
            if (target.type === 'checkbox' && target.dataset.action === 'exclude-participant') {
                const id = target.dataset.id;
                if (target.checked) {
                    excludedParticipantIds.add(id);
                } else {
                    excludedParticipantIds.delete(id);
// ... (既存の関数) ...
                }
            }
        }

        // ★割り当て実行 (ドライバーと別便対応)
        function handleAssignment() {
            if (selectedCarIds.size === 0) {
                showMessage('ステップ2で車を1台以上選択してください。', 'error');
                return;
            }

            let errors = [];
            let driverMap = new Map(); // carId -> driverObject
            let selectedCarsData = [];
            
            // 1. 参加者全員のリスト（データ付き）を作成
            const allParticipantsWithData = ALL_PARTICIPANTS_FLAT
                .filter(p => selectedParticipantIds.has(p.id)) // 参加者のみ
                .map(p => {
                    const family = FAMILIES.find(f => f.members.some(m => m.id === p.id));
                    return {
                        ...p,
                        ...participantData.get(p.id), // grade, school, other, memo を展開
                        familyName: family ? family.familyName : null
                    };
                });


            // 2. 車とドライバーのバリデーション
            selectedCarIds.forEach(carId => {
                const driverId = selectedDrivers.get(carId);
                if (!driverId) {
                    errors.push(`${AVAILABLE_CARS_INFO.find(c=>c.id === carId).name} のドライバーが選択されていません。`);
                    return;
                }
                
                const driver = allParticipantsWithData.find(p => p.id === driverId);
                if (!driver) { 
                     // ドライバーが参加者に選ばれていない
                     const driverInfo = ALL_PARTICIPANTS_FLAT.find(p=>p.id === driverId);
                     errors.push(`ドライバー (${driverInfo.name} (${driverInfo.type})) がステップ1の参加者に含まれていません。`);
                     return;
                }
                
                if ([...driverMap.values()].some(d => d.id === driverId)) {
                    errors.push(`ドライバー (${driver.name} (${driver.type})) が複数の車に割り当てられています。`);
                }
                driverMap.set(carId, driver);
                
                const carInfo = AVAILABLE_CARS_INFO.find(c => c.id === carId);
                const hasLuggage = selectedLuggage.has(carId);
                let actualCapacity = carInfo.baseCapacity - 1; // ドライバー分
                if (hasLuggage) {
                    actualCapacity = 1; // 荷物ありなら乗客は1名のみ
                }

                selectedCarsData.push({
                    id: carId,
                    name: carInfo.name,
                    familyName: carInfo.familyName,
                    driverId: driverId, // 自動割り当てロジックで使用
                    capacity: actualCapacity, 
                    hasLuggage: hasLuggage
                });
            });

            if (errors.length > 0) {
                showMessage(errors.join('<br>'), 'error');
                return;
            }

            // 3. 割り当て対象の乗客リストを作成 (ドライバーと除外者を *除く*)
            const driverIds = new Set([...driverMap.values()].map(d => d.id));
            let participantsToAssign = allParticipantsWithData.filter(p => {
                return !driverIds.has(p.id) && !excludedParticipantIds.has(p.id);
            });
            
            // 4. 別便リストを作成
            let excludedParticipants = allParticipantsWithData.filter(p => {
                return excludedParticipantIds.has(p.id) && !driverIds.has(p.id); // ドライバーは別便にしない
            });

            // 5. 全体の定員チェック
            const totalParticipants = participantsToAssign.length;
            const totalCapacity = selectedCarsData.reduce((sum, car) => sum + car.capacity, 0);

            if (totalParticipants > totalCapacity) {
                showMessage(`定員オーバーです。参加者 ${totalParticipants}人 に対して、車の乗客定員は合計 ${totalCapacity}人 です。`, 'error');
            } else {
                hideMessage();
            }

            // 6. 割り当てロジックの実行
            const assignments = allocateParticipants(participantsToAssign, selectedCarsData, driverMap);

            // 7. 別便カーを追加
            assignments.push({
                id: 'excluded-car',
                name: '別便',
                capacity: 999,
                driver: null,
                members: excludedParticipants,
                hasLuggage: false
            });

            // 8. 結果の描画と保存
            currentAssignments = assignments; 
            renderResults(currentAssignments);
            
            currentAssignments.forEach(car => {
                car.element = document.getElementById(`car-result-${car.id}`);
            });

            updateTextOutput();
        }
        

        // --- メッセージとロジック ---

        function showMessage(message, type = 'info') {
// ... (既存の関数) ...
            messageText.innerHTML = message;
            messageContainer.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-blue-100', 'border-blue-400', 'text-blue-700');
            if (type === 'error') {
                messageContainer.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else {
                messageContainer.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
            }
            messageContainer.classList.remove('hidden');
        }

        function hideMessage() {
// ... (既存の関数) ...
            messageContainer.classList.add('hidden');
        }

        // ★割り当てロジック (ドライバーを引数で受け取る)
        function allocateParticipants(participants, cars, driverMap) {
            // 1. 割り当て結果の器を初期化 (ドライバーをセット)
            let assignments = cars.map(car => ({ 
                ...car, 
                driver: driverMap.get(car.id) || null, // ドライバーをセット
                members: [] 
            }));
            
            if (participants.length === 0) return assignments;

            let remainingParticipants = [...participants]; 
            
            const typePriority = { '保護者': 1, '兄弟': 2, '選手': 3, 'その他': 4 };

            // --- 優先度1: 家族を自分の車に乗せる ---
            assignments.forEach(car => {
                if (!car.driver || !car.familyName) return;
                
                // ドライバーの家族名と車の家族名が一致する場合のみ
                if (car.driver.familyName === car.familyName) {
                    let familyMembersInThisCar = remainingParticipants
                        .filter(p => p.familyName === car.familyName) // 同じ家族
                        .sort((a, b) => (typePriority[a.type] || 9) - (typePriority[b.type] || 9));

                    familyMembersInThisCar.forEach(member => {
                        if (car.members.length < car.capacity) {
                            car.members.push(member);
                            remainingParticipants = remainingParticipants.filter(p => p.id !== member.id);
                        }
                    });
                }
            });

            // --- 優先度2: フラググループ ---
            let flaggedParticipants = [];
            let nonFlaggedParticipants = [];

            remainingParticipants.forEach(p => {
                const hasFlags = p.grade || p.school || p.other;
                if (hasFlags && p.isFlagTarget) { 
                    flaggedParticipants.push(p);
                } else {
                    nonFlaggedParticipants.push(p);
                }
            });

            const flagGroupsMap = new Map();
            flaggedParticipants.forEach(p => {
                const grade = p.grade || '';
                const school = p.school || '';
                const other = p.other || '';
                
                let key, priority;
                
                if (grade && school) { key = `GS:${grade}/${school}`; priority = 1; }
                else if (grade) { key = `G:${grade}`; priority = 2; }
                else if (school) { key = `S:${school}`; priority = 3; }
                else if (other) { key = `O:${other}`; priority = 4; }
                else { return; }

                if (!flagGroupsMap.has(key)) {
                    flagGroupsMap.set(key, { priority, members: [] });
                }
                flagGroupsMap.get(key).members.push(p);
            });

            const sortedFlagGroups = Array.from(flagGroupsMap.values())
                .filter(group => group.members.length > 1) 
                .sort((a, b) => {
                    if (a.priority !== b.priority) return a.priority - b.priority;
                    return b.members.length - a.members.length;
                });
            
            let finalRemainingParticipants = [...nonFlaggedParticipants]; 
            const remainingFlaggedIds = new Set(flaggedParticipants.map(p => p.id)); 

            sortedFlagGroups.forEach(group => {
                let bestFitCar = assignments
                    .map(car => ({ carRef: car, vacancy: car.capacity - car.members.length }))
                    .filter(c => c.vacancy >= group.members.length)
                    .sort((a, b) => b.vacancy - a.vacancy)[0]; 

                if (bestFitCar) {
                    bestFitCar.carRef.members.push(...group.members);
                    group.members.forEach(p => remainingFlaggedIds.delete(p.id));
                }
            });
            
            remainingFlaggedIds.forEach(id => {
                finalRemainingParticipants.push(flaggedParticipants.find(p => p.id === id));
            });
            
            // --- 優先度3: 残りの個人 ---
            if (finalRemainingParticipants.length > 0) {
                const shuffledRemaining = finalRemainingParticipants.sort(() => 0.5 - Math.random());
                
                let carsWithVacancy = assignments
                    .map(car => ({ carRef: car, vacancy: car.capacity - car.members.length }))
                    .filter(c => c.vacancy > 0)
                    .sort((a, b) => b.vacancy - a.vacancy); 

                let carIndex = 0;
                while (shuffledRemaining.length > 0) {
                    if (carsWithVacancy.length === 0) break; 

                    const targetCarInfo = carsWithVacancy[carIndex % carsWithVacancy.length];
                    
                    if (targetCarInfo.carRef.members.length < targetCarInfo.carRef.capacity) {
                        targetCarInfo.carRef.members.push(shuffledRemaining.pop());
                    }
                    carIndex++;
                    carsWithVacancy = carsWithVacancy.filter(c => c.carRef.members.length < c.carRef.capacity);
                    if (carsWithVacancy.length > 0) { 
                        carIndex = carIndex % carsWithVacancy.length;
                    }
                }
            }
            return assignments;
        }


        // アコーディオンの全開/全閉
        function handleToggleDetails() {
// ... (既存の関数) ...
            const detailsElements = participantListEl.querySelectorAll('details');
            const shouldOpen = toggleDetailsButton.textContent === 'すべて開く';
            detailsElements.forEach(details => {
                details.open = shouldOpen;
            });
            toggleDetailsButton.textContent = shouldOpen ? 'すべて閉じる' : 'すべて開く';
        }


        // --- ファイル入出力・テキスト出力機能 ---

        // 現在の状態を取得
        function getCurrentState() {
            return {
                selectedParticipantIds: Array.from(selectedParticipantIds),
                selectedCarIds: Array.from(selectedCarIds),
                selectedDrivers: Array.from(selectedDrivers.entries()),
                selectedLuggage: Array.from(selectedLuggage),
                excludedParticipantIds: Array.from(excludedParticipantIds),
                participantData: Array.from(participantData.entries()) // ★変更
            };
        }

        // 状態を復元
        function restoreState(state) {
            selectedParticipantIds = new Set(state.selectedParticipantIds || []);
            selectedCarIds = new Set(state.selectedCarIds || []);
            selectedDrivers = new Map(state.selectedDrivers || []);
            selectedLuggage = new Set(state.selectedLuggage || []);
            excludedParticipantIds = new Set(state.excludedParticipantIds || []);
            participantData = new Map(state.participantData || []); // ★変更
            
            if (participantData.size === 0) {
                initializeParticipantData(); // ★変更
            }

            currentAssignments = [];
        }

        // 状態をエクスポート
        function handleExportState() {
// ... (既存の関数) ...
            const state = getCurrentState();
            const jsonString = JSON.stringify(state, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
// ... (既存の関数) ...
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `car_assignment_state_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
// ... (既存の関数) ...
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('現在の状態をファイルに保存しました。', 'info');
// ... (既存の関数) ...
        }

        // 状態をインポート
        function handleImportState(e) {
            const file = e.target.files[0];
// ... (既存の関数) ...
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
// ... (既存の関数) ...
                    const state = JSON.parse(event.target.result);
                    restoreState(state);
                    
                    // UIを再描画
                    renderParticipantList();
// ... (既存の関数) ...
                    renderCarList();
                    renderExclusionList();
                    resultsEl.innerHTML = '<p id="results-placeholder" class="text-gray-500 text-sm bg-white p-4 rounded-lg shadow min-h-[50px]">ステップ4の「割り当て実行」を押してください。</p>';
                    const placeholder = document.getElementById('results-placeholder');
// ... (既存の関数) ...
                    if (placeholder) {
                         if (window.innerWidth >= 1024) { // lg breakpoint
                            placeholder.style.gridColumn = `span ${LAYOUT_COLUMNS}`;
                        } else {
                            placeholder.style.gridColumn = 'auto';
                        }
                    }
// ... (既存の関数) ...
                    textOutputContainer.classList.add('hidden'); // テキスト出力も隠す
                    
                    showMessage('状態を読み込みました。', 'info');
                } catch (err) {
                    console.error('Error parsing JSON state:', err);
// ... (既存の関数) ...
                    showMessage('ファイルの読み込みに失敗しました。無効なJSONファイルです。', 'error');
                }
                // 同じファイルを再度読み込めるように input の値をリセット
                e.target.value = null;
            };
            reader.readAsText(file);
// ... (既存の関数) ...
        }

        // テキスト出力の表示/非表示
        function handleShowTextOutput() {
            if (currentAssignments.length === 0) {
                showMessage('テキスト出力する結果がありません。先に「割り当て実行」を押してください。', 'error');
// ... (既存の関数) ...
                return;
            }
            textOutputContainer.classList.toggle('hidden');
            if (!textOutputContainer.classList.contains('hidden')) {
                updateTextOutput(); // 表示する瞬間に内容を最新化
// ... (既存の関数) ...
            }
        }

        // ★テキスト出力エリアを更新 (備考対応)
        function updateTextOutput() {
            if (currentAssignments.length === 0) {
// ... (既存の関数) ...
                textOutputEl.value = '';
                return;
            }

            const outputLines = currentAssignments
                .filter(car => car.id !== 'excluded-car') // 別便カーは除外
                .map(car => {
                
                const carName = car.name.replace(/の車|家の車/g, 'カー');
                
                // ドライバー
                let driverName = ' (ドライバー未定)';
                if (car.driver) {
                    const memo = participantData.get(car.driver.id)?.memo || '';
                    driverName = car.driver.name + (memo ? ` (${memo})` : '');
                }
                
                // 乗客リスト
                const members = car.members.map(p => {
                    let name = p.name;
                    if (p.type === '選手') name = '★' + name;
                    const memo = participantData.get(p.id)?.memo || '';
                    return name + (memo ? ` (${memo})` : '');
                });
                
                const luggage = car.hasLuggage ? '荷物' : null;
                
                const parts = [driverName, ...members];
                if (luggage) parts.push(luggage);
                
                return `${carName} (${parts.join(', ')})`;
            });

            textOutputEl.value = outputLines.join('\n');
        }

        // テキストをコピー
        function handleCopyTextOutput() {
// ... (既存の関数) ...
            if (!textOutputEl.value) return;

            try {
                navigator.clipboard.writeText(textOutputEl.value).then(() => {
                    showMessage('クリップボードにコピーしました。', 'info');
// ... (既存の関数) ...
                }, (err) => {
                    legacyCopy(textOutputEl.value);
                });
            } catch (err) {
                legacyCopy(textOutputEl.value);
// ... (既存の関数) ...
            }
        }

        // 古いコピー方法 (フォールバック)
        function legacyCopy(text) {
             const textArea = document.createElement('textarea');
// ... (既存の関数) ...
            textArea.value = text;
            textArea.style.position = 'fixed'; // 画面外
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
// ... (既存の関数) ...
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
// ... (既存の関数) ...
                    showMessage('クリップボードにコピーしました。', 'info');
                } else {
                    showMessage('コピーに失敗しました。', 'error');
                }
            } catch (err) {
// ... (既存の関数) ...
                showMessage('コピーに失敗しました。', 'error');
            }
            document.body.removeChild(textArea);
        }

        // --- マスターデータ入出力 ---

// ... (既存の関数) ...
        // マスターデータをエクスポート
        function handleExportMasterData() {
            const masterData = {
                families: FAMILIES,
                cars: AVAILABLE_CARS_INFO
            };
// ... (既存の関数) ...
            const jsonString = JSON.stringify(masterData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
// ... (既存の関数) ...
            a.href = url;
            a.download = `car_assignment_master_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
// ... (既存の関数) ...
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('現在のマスターデータをファイルに保存しました。', 'info');
        }

        // マスターデータをインポート
// ... (既存の関数) ...
        function handleImportMasterData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
// ... (既存の関数) ...
            reader.onload = (event) => {
                try {
                    const masterData = JSON.parse(event.target.result);
                    
                    if (!masterData || !Array.isArray(masterData.families) || !Array.isArray(masterData.cars)) {
                        throw new Error('JSONの形式が正しくありません。 "families" と "cars" の配列が必要です。');
// ... (既存の関数) ...
                    }

                    // グローバル変数を上書き
                    FAMILIES = masterData.families;
                    AVAILABLE_CARS_INFO = masterData.cars;
// ... (既存の関数) ...
                    
                    // 派生データを再計算
                    ALL_PARTICIPANTS_FLAT = FAMILIES.flatMap(f => f.members);

                    // 状態をすべてリセット
                    restoreState({}); // 空の状態でリセット
// ... (既存の関数) ...
                    
                    // UIを完全に再描画
                    initializeParticipantData(); // ★変更
                    renderParticipantList();
                    renderCarList();
// ... (既存の関数) ...
                    renderExclusionList();
                    resultsEl.innerHTML = '<p id="results-placeholder" class="text-gray-500 text-sm bg-white p-4 rounded-lg shadow min-h-[50px]">ステップ4の「割り当て実行」を押してください。</p>';
                    const placeholder = document.getElementById('results-placeholder');
                    if (placeholder) {
// ... (既存の関数) ...
                         if (window.innerWidth >= 1024) { // lg breakpoint
                            placeholder.style.gridColumn = `span ${LAYOUT_COLUMNS}`;
                        } else {
                            placeholder.style.gridColumn = 'auto';
// ... (既存の関数) ...
                        }
                    }
                    textOutputContainer.classList.add('hidden'); // テキスト出力も隠す
                    toggleDetailsButton.textContent = 'すべて開く'; // ボタンをリセット
// ... (既存の関数) ...
                    
                    showMessage('マスターデータを読み込み、アプリをリセットしました。', 'info');
                } catch (err) {
                    console.error('Error parsing master data JSON:', err);
                    showMessage(`マスターデータの読み込みに失敗しました: ${err.message}`, 'error');
// ... (既存の関数) ...
                }
                // 同じファイルを再度読み込めるように input の値をリセット
                e.target.value = null;
            };
            reader.readAsText(file);
// ... (既存の関数) ...
        }

    </script>

</body>
</html>

