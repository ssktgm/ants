<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>配車調整アプリ</title>
    <style>
        /* Tailwind JIT/CDN 用のベーススタイル */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* 3列レイアウト用のカスタムスタイル */
        :root {
            --layout-columns: 3; /* デフォルト */
        }
        
        @media (min-width: 768px) { /* md */
            .grid-layout-dynamic {
                grid-template-columns: repeat(var(--layout-columns), minmax(0, 1fr));
            }
        }

        /* 割り当て結果の高さ */
        .car-assignment-list {
            min-height: 150px;
        }

        /* ドラッグ&ドロップのハイライト */
        .drag-over-bg {
            background-color: #ebf8ff; /* bg-blue-50 */
        }
        .drag-over-border {
            outline: 2px dashed #63b3ed; /* blue-400 */
            outline-offset: -2px;
        }
        .drag-over-insert-before::before,
        .drag-over-insert-after::after {
            content: '';
            display: block;
            height: 4px;
            background-color: #3182ce; /* blue-600 */
            margin: 2px 0;
        }

        /* タッチ操作のゴースト要素 */
        .touch-ghost {
            position: fixed;
            pointer-events: none;
            opacity: 0.7;
            z-index: 1000;
            transform: translate(-50%, -50px); /* 指の少し上に出るように調整 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-radius: 0.375rem; /* rounded-md */
        }

        /* メッセージ表示 */
        #message-box {
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        #message-box.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        
        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6">配車調整アプリ</h1>

        <!-- グローバルコントロールボタン -->
        <div class="mb-6 bg-white p-4 rounded-lg shadow-sm max-w-md">
            <h2 class="font-semibold text-lg mb-3">状態</h2>
            <div class="grid grid-cols-2 gap-3">
                <button id="export-state-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">状態を保存</button>
                <label class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-center cursor-pointer">
                    状態を読み込む
                    <input type="file" id="import-state-input" class="hidden" accept=".json">
                </label>
            </div>
            <h2 class="font-semibold text-lg mt-5 mb-3">マスター</h2>
            <div class="grid grid-cols-2 gap-3">
                <button id="export-master-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">マスターを保存</button>
                <label class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-center cursor-pointer">
                    マスターを読み込む
                    <input type="file" id="import-master-input" class="hidden" accept=".json">
                </label>
            </div>
        </div>

        <!-- メインコンテンツグリッド -->
        <div id="main-grid" class="grid grid-cols-1 md:grid-layout-dynamic gap-6">

            <!-- ステップ1: 参加者 -->
            <section id="step1-participants" class="bg-white p-4 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-700">1. 参加者を選択</h2>
                    <button id="toggle-all-participants" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-1 px-3 rounded-lg">すべて閉じる</button>
                </div>
                <div id="participant-list" class="space-y-4">
                    <!-- JSで描画 -->
                </div>
            </section>

            <!-- ステップ2: 車とドライバー -->
            <section id="step2-cars" class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-xl font-bold text-gray-700 mb-4">2. 車とドライバーを選択</h2>
                <div id="car-list" class="space-y-4">
                    <!-- JSで描画 -->
                </div>
            </section>

            <!-- ステップ3 & 4: 除外 & 実行 -->
            <section id="step3-exclusions" class="bg-white p-4 rounded-lg shadow">
                <h2 class="text-xl font-bold text-gray-700 mb-4">3. 別便の人を除外</h2>
                <div id="exclusion-list" class="space-y-2 mb-6">
                    <!-- JSで描画 -->
                </div>
                
                <h2 class="text-xl font-bold text-gray-700 mb-4">4. 割り当て実行</h2>
                <button id="assign-button" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 shadow">
                    割り当て実行
                </button>
            </section>
        </div>

        <!-- ステップ5: 割り当て結果 -->
        <section id="step5-results" class="mt-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">5. 割り当て結果</h2>
            <div id="assignment-results" class="grid grid-cols-1 md:grid-layout-dynamic gap-6">
                <!-- JSで描画 -->
            </div>
        </section>

        <!-- ステップ6: テキスト出力 -->
        <section id="step6-output" class="mt-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">6. テキスト出力</h2>
            <div class="bg-white p-4 rounded-lg shadow">
                <textarea id="text-output" rows="10" class="w-full p-3 border border-gray-300 rounded-md bg-gray-50 font-mono text-sm" readonly></textarea>
                <button id="copy-text-btn" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                    テキストをコピー
                </button>
            </div>
        </section>

    </div>

    <!-- メッセージ表示エリア -->
    <div id="message-box" class="fixed top-8 right-8 p-4 rounded-lg shadow-lg max-w-sm text-white opacity-0 transform -translate-y-10" role="alert">
        <span id="message-text"></span>
    </div>

<script>
    // --- 定数 & グローバル変数 ---
    const LAYOUT_COLUMNS = 3;
    
    // マスターデータ (letで上書き可能に)
    let FAMILIES = [];
    let AVAILABLE_CARS_INFO = [];
    let ALL_PARTICIPANTS_FLAT = []; // FAMILIESから生成されるフラットなリスト

    // 状態管理
    let selectedParticipantIds = new Set();
    let selectedCarIds = new Set();
    let excludedParticipantIds = new Set();
    let participantFlags = new Map(); // { 'p1': { grade: '5年', school: '東小', other: '', remarks: '' } }
    let carSettings = new Map(); // { 'c1': { driverId: 'p2', hasLuggage: false } }
    
    // 割り当て結果
    let currentAssignments = new Map(); // { 'c1': { driver: pObj, passengers: [pObj, ...], capacity: 4 }, 'c_excluded': { ... } }

    // DOM要素
    const participantListEl = document.getElementById('participant-list');
    const carListEl = document.getElementById('car-list');
    const exclusionListEl = document.getElementById('exclusion-list');
    const assignButton = document.getElementById('assign-button');
    const assignmentResultsEl = document.getElementById('assignment-results');
    const textOutputEl = document.getElementById('text-output');
    const copyTextBtn = document.getElementById('copy-text-btn');
    const messageBox = document.getElementById('message-box');
    const messageText = document.getElementById('message-text');
    const toggleAllParticipantsBtn = document.getElementById('toggle-all-participants');
    
    const exportStateBtn = document.getElementById('export-state-btn');
    const importStateInput = document.getElementById('import-state-input');
    const exportMasterBtn = document.getElementById('export-master-btn');
    const importMasterInput = document.getElementById('import-master-input');

    // ドラッグ＆ドロップ＆タッチ状態
    let draggedElement = null;
    let draggedData = null; // { type: 'driver'/'passenger', id: 'p1', fromCar: 'c1' }
    let touchGhost = null;
    let longPressTimer = null;


    // --- 初期化 ---

    // デフォルトマスターデータの設定
    function setDefaultMasterData() {
        FAMILIES = [
            // 家族: 小高
            { 
                familyName: "小高家",
                carId: "c_kodaka",
                members: [
                    { id: 'p_kodaka_1', name: '斗愛', type: '選手', isFlagTarget: true, flags: { grade: '5年', school: '東小', other: '' } },
                    { id: 'p_kodaka_2', name: '愛之佑', type: '選手', isFlagTarget: true, flags: { grade: '3年', school: '東小', other: '' } },
                    { id: 'p_kodaka_3', name: '小高監督', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_kodaka_4', name: '小高母', type: '保護者', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 難波
            {
                familyName: "難波家",
                carId: "c_namba",
                members: [
                    { id: 'p_namba_1', name: '諒成', type: '選手', isFlagTarget: true, flags: { grade: '5年', school: '東小', other: '' } },
                    { id: 'p_namba_2', name: '難波父', type: '保護者', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 浪川
            {
                familyName: "浪川家",
                carId: "c_namikawa_1", // 浪川カー①
                members: [
                    { id: 'p_namikawa_1', name: '長政', type: '選手', isFlagTarget: true, flags: { grade: '5年', school: '東小', other: '' } },
                    { id: 'p_namikawa_2', name: '浪川父', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_namikawa_3', name: '浪川母', type: '保護者', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 高橋
            {
                familyName: "高橋家",
                carId: null, // 車なし
                members: [
                    { id: 'p_takahashi_1', name: '湊多', type: '選手', isFlagTarget: true, flags: { grade: '5年', school: '東小', other: '' } },
                ]
            },
            // 家族: 山田
            {
                familyName: "山田家",
                carId: "c_yamada_1", // 山田カー①
                members: [
                    { id: 'p_yamada_1', name: '颯真', type: '選手', isFlagTarget: true, flags: { grade: '4年', school: '東小', other: '' } },
                    { id: 'p_yamada_2', name: '山田父', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_yamada_3', name: '山田母', type: '保護者', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 菱沼
            {
                familyName: "菱沼家",
                carId: "c_hishinuma",
                members: [
                    { id: 'p_hishinuma_1', name: '颯介', type: '選手', isFlagTarget: true, flags: { grade: '4年', school: '東小', other: '' } },
                    { id: 'p_hishinuma_2', name: '菱沼父', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_hishinuma_3', name: '菱沼母', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_hishinuma_4', name: 'つぐみ', type: '兄弟', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 小野
            {
                familyName: "小野家",
                carId: "c_ono",
                members: [
                    { id: 'p_ono_1', name: '暁人', type: '選手', isFlagTarget: true, flags: { grade: '4年', school: '東小', other: '' } },
                    { id: 'p_ono_2', name: '小野母', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_ono_3', name: 'ななか', type: '兄弟', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 津村
            {
                familyName: "津村家",
                carId: null, // 車なし
                members: [
                    { id: 'p_tsumura_1', name: '一樹', type: '選手', isFlagTarget: true, flags: { grade: '4年', school: '東小', other: '' } },
                    { id: 'p_tsumura_2', name: '津村父', type: '保護者', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 浅野
            {
                familyName: "浅野家",
                carId: "c_asano",
                members: [
                    { id: 'p_asano_1', name: '泰地', type: '選手', isFlagTarget: true, flags: { grade: '3年', school: '西小', other: '' } },
                    { id: 'p_asano_2', name: '浅野父', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_asano_3', name: '浅野母', type: '保護者', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 近藤
            {
                familyName: "近藤家",
                carId: "c_kondo",
                members: [
                    { id: 'p_kondo_1', name: '譲成', type: '選手', isFlagTarget: true, flags: { grade: '3年', school: '西小', other: '' } },
                    { id: 'p_kondo_2', name: '近藤父', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_kondo_3', name: '近藤母', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_kondo_4', name: 'おうすけ', type: '兄弟', isFlagTarget: false, flags: {} },
                    { id: 'p_kondo_5', name: '茉莉', type: '選手', isFlagTarget: true, flags: { grade: '1年', school: '西小', other: '' } },
                ]
            },
            // 家族: 知野見
            {
                familyName: "知野見家",
                carId: "c_chinomi",
                members: [
                    { id: 'p_chinomi_1', name: '怜央', type: '選手', isFlagTarget: true, flags: { grade: '3年', school: '西小', other: '' } },
                    { id: 'p_chinomi_2', name: '知野見父', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_chinomi_3', name: '知野見母', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_chinomi_4', name: 'ゆな', type: '兄弟', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 藤山
            {
                familyName: "藤山家",
                carId: "c_fujiyama",
                members: [
                    { id: 'p_fujiyama_1', name: '琉杜', type: '選手', isFlagTarget: true, flags: { grade: '3年', school: '西小', other: '' } },
                    { id: 'p_fujiyama_2', name: '藤山父', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_fujiyama_3', name: '藤山母', type: '保護者', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 小河原
            {
                familyName: "小河原家",
                carId: "c_ogawara_1", // 小河原カー①
                members: [
                    { id: 'p_ogawara_1', name: '維', type: '選手', isFlagTarget: true, flags: { grade: '3年', school: '西小', other: '' } },
                    { id: 'p_ogawara_2', name: '小河原父', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_ogawara_3', name: '小河原母', type: '保護者', isFlagTarget: false, flags: {} },
                    { id: 'p_ogawara_4', name: '小河原父or母', type: 'その他', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 古川
            {
                familyName: "古川家",
                carId: "c_furukawa",
                members: [
                    { id: 'p_furukawa_1', name: '峻丞', type: '選手', isFlagTarget: true, flags: { grade: '2年', school: '西小', other: '' } },
                    { id: 'p_furukawa_2', name: '古川父', type: '保護者', isFlagTarget: false, flags: {} },
                ]
            },
            // 家族: 坪井
            {
                familyName: "坪井家",
                carId: null, // 車なし
                members: [
                    { id: 'p_tsuboi_1', name: '雄也', type: '選手', isFlagTarget: true, flags: { grade: '1年', school: '西小', other: '' } },
                    { id: 'p_tsuboi_2', name: '坪井父', type: '保護者', isFlagTarget: false, flags: {} },
                ]
            },
            // スタッフ・個人
            {
                familyName: "スタッフ・個人",
                carId: null,
                members: [
                    { id: 'p_staff_1', name: 'コーチ', type: 'その他', isFlagTarget: false, flags: {} },
                ]
            }
        ];

        AVAILABLE_CARS_INFO = [
            { id: 'c_kodaka', name: '小高カー', type: 'セレナ', capacity: 6, familyName: '小高家' },
            { id: 'c_namba', name: '難波カー', type: 'アルファード', capacity: 7, familyName: '難波家' },
            { id: 'c_namikawa_1', name: '浪川カー①', type: 'セレナ', capacity: 6, familyName: '浪川家' },
            { id: 'c_namikawa_2', name: '浪川カー②', type: 'プリウス', capacity: 5, familyName: '浪川家' },
            { id: 'c_yamada_1', name: '山田カー①', type: 'アルファード', capacity: 7, familyName: '山田家' },
            { id: 'c_yamada_2', name: '山田カー②', type: 'プリウス', capacity: 5, familyName: '山田家' },
            { id: 'c_hishinuma', name: '菱沼カー', type: 'セレナ', capacity: 6, familyName: '菱沼家' },
            { id: 'c_ono', name: '小野カー', type: 'ステップワゴン', capacity: 8, familyName: '小野家' },
            { id: 'c_asano', name: '浅野カー', type: 'ステップワゴン', capacity: 8, familyName: '浅野家' },
            { id: 'c_kondo', name: '近藤カー', type: 'セレナ', capacity: 6, familyName: '近藤家' },
            { id: 'c_chinomi', name: '知野見カー', type: 'VOXY', capacity: 7, familyName: '知野見家' }, // 定員仮
            { id: 'c_fujiyama', name: '藤山カー', type: '?', capacity: 4, familyName: '藤山家' },
            { id: 'c_ogawara_1', name: '小河原カー①', type: 'クラウン', capacity: 4, familyName: '小河原家' },
            { id: 'c_ogawara_2', name: '小河原カー②', type: '?', capacity: 4, familyName: '小河原家' },
            { id: 'c_furukawa', name: '古川カー', type: 'ステップワゴン', capacity: 8, familyName: '古川家' },
        ];
    }
    
    // 参加者データを初期化
    function initializeParticipantData() {
        // フラットリストを生成
        ALL_PARTICIPANTS_FLAT = FAMILIES.flatMap(f => f.members.map(m => ({...m, familyName: f.familyName})));
        
        // フラグと備考の初期化
        participantFlags.clear();
        ALL_PARTICIPANTS_FLAT.forEach(p => {
            participantFlags.set(p.id, {
                grade: p.flags?.grade || '',
                school: p.flags?.school || '',
                other: p.flags?.other || '',
                remarks: '' // 備考は常に空で初期化
            });
        });
    }

    // デフォルトドライバーを設定
    function initializeDefaultDrivers() {
        carSettings.clear();
        AVAILABLE_CARS_INFO.forEach(car => {
            let defaultDriverId = null;
            const family = FAMILIES.find(f => f.familyName === car.familyName);
            if (family) {
                // 家族から「父」を優先して探す
                const father = family.members.find(m => m.name.includes('父'));
                if (father) {
                    defaultDriverId = father.id;
                } else {
                    // 「父」がいなければ「母」を探す
                    const mother = family.members.find(m => m.name.includes('母'));
                    if (mother) {
                        defaultDriverId = mother.id;
                    }
                }
            }
            carSettings.set(car.id, {
                driverId: defaultDriverId,
                hasLuggage: false
            });
        });
    }
    
    // 列数の設定
    function setLayoutColumns() {
        document.documentElement.style.setProperty('--layout-columns', LAYOUT_COLUMNS);
    }

    // --- 描画関数 ---

    // ステップ1: 参加者リストを描画
    function renderParticipantList() {
        participantListEl.innerHTML = '';
        FAMILIES.forEach(family => {
            const details = document.createElement('details');
            details.className = 'bg-gray-50 rounded border';
            details.open = true; // デフォルトで開く
            
            const summary = document.createElement('summary');
            summary.className = 'p-3 font-semibold cursor-pointer select-none';
            summary.innerHTML = `
                <div class="flex justify-between items-center">
                    <span>${family.familyName}</span>
                    <div class="space-x-1">
                        <button type="button" data-family-name="${family.familyName}" data-action="family-select-all" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 font-medium py-1 px-2 rounded-lg" style="font-size: 0.7rem;">
                            全員参加
                        </button>
                        <button type="button" data-family-name="${family.familyName}" data-action="family-select-none" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-1 px-2 rounded-lg" style="font-size: 0.7rem;">
                            全員不参加
                        </button>
                    </div>
                </div>
            `;
            
            const memberList = document.createElement('div');
            memberList.className = 'p-3 border-t border-gray-200 space-y-4';
            
            family.members.forEach(p => {
                const isSelected = selectedParticipantIds.has(p.id);
                const flags = participantFlags.get(p.id) || { grade: '', school: '', other: '', remarks: '' };
                const disabledClass = isSelected ? '' : 'opacity-50';
                
                memberList.innerHTML += `
                    <div class="space-y-2" id="p-container-${p.id}">
                        <div class="flex items-center">
                            <input type="checkbox" id="p-${p.id}" data-action="select-participant" data-participant-id="${p.id}" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isSelected ? 'checked' : ''}>
                            <label for="p-${p.id}" class="ml-3 text-sm text-gray-800">
                                ${p.name} <span class="text-gray-500">(${p.type})</span>
                            </label>
                        </div>
                        <div id="data-inputs-${p.id}" class="pl-8 grid grid-cols-2 md:grid-cols-4 gap-2 ${disabledClass}">
                            ${p.isFlagTarget ? `
                                <input type="text" data-participant-id="${p.id}" data-field="grade" value="${flags.grade}" placeholder="学年" class="w-full text-xs p-1.5 border border-gray-300 rounded-md" ${!isSelected ? 'disabled' : ''}>
                                <input type="text" data-participant-id="${p.id}" data-field="school" value="${flags.school}" placeholder="学校" class="w-full text-xs p-1.5 border border-gray-300 rounded-md" ${!isSelected ? 'disabled' : ''}>
                                <input type="text" data-participant-id="${p.id}" data-field="other" value="${flags.other}" placeholder="他" class="w-full text-xs p-1.5 border border-gray-300 rounded-md" ${!isSelected ? 'disabled' : ''}>
                            ` : '<div class="col-span-3"></div>'}
                            <textarea data-participant-id="${p.id}" data-field="remarks" placeholder="備考" class="w-full text-xs p-1.5 border border-gray-300 rounded-md col-span-2 md:col-span-1" rows="1" ${!isSelected ? 'disabled' : ''}>${flags.remarks}</textarea>
                        </div>
                    </div>
                `;
            });
            
            details.appendChild(summary);
            details.appendChild(memberList);
            participantListEl.appendChild(details);
        });
    }

    // ステップ2: 車リストを描画
    function renderCarList() {
        carListEl.innerHTML = '';
        AVAILABLE_CARS_INFO.forEach(car => {
            const isSelected = selectedCarIds.has(car.id);
            const settings = carSettings.get(car.id) || { driverId: null, hasLuggage: false };
            const disabledClass = isSelected ? '' : 'opacity-50';

            // ドライバー選択肢
            const family = FAMILIES.find(f => f.familyName === car.familyName);
            let driverOptions = '<option value="">ドライバー未選択</option>';
            if (family) {
                family.members.forEach(p => {
                    driverOptions += `<option value="${p.id}" ${settings.driverId === p.id ? 'selected' : ''}>${p.name}</option>`;
                });
            }

            carListEl.innerHTML += `
                <div class="border rounded-lg p-3 ${isSelected ? 'bg-blue-50' : 'bg-gray-50'}">
                    <div class="flex items-center">
                        <input type="checkbox" id="c-${car.id}" data-action="select-car" data-car-id="${car.id}" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isSelected ? 'checked' : ''}>
                        <label for="c-${car.id}" class="ml-3 text-sm font-semibold text-gray-800">
                            ${car.name} <span class="text-gray-500 font-normal">(${car.type} / ${car.capacity}名)</span>
                        </label>
                    </div>
                    <div class="pl-8 mt-3 space-y-3 ${disabledClass}">
                        <div>
                            <label for="driver-${car.id}" class="block text-xs font-medium text-gray-600 mb-1">ドライバー</label>
                            <select id="driver-${car.id}" data-car-id="${car.id}" data-field="driverId" class="w-full text-sm p-2 border border-gray-300 rounded-md" ${!isSelected ? 'disabled' : ''}>
                                ${driverOptions}
                            </select>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="luggage-${car.id}" data-car-id="${car.id}" data-field="hasLuggage" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${settings.hasLuggage ? 'checked' : ''} ${!isSelected ? 'disabled' : ''}>
                            <label for="luggage-${car.id}" class="ml-2 text-sm text-gray-700">荷物あり (定員が運転手含め2名になります)</label>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    // ステップ3: 除外リストを描画
    function renderExclusionList() {
        exclusionListEl.innerHTML = '';
        if (selectedParticipantIds.size === 0) {
            exclusionListEl.innerHTML = '<p class="text-sm text-gray-500">参加者が選択されていません。</p>';
            return;
        }

        let count = 0;
        selectedParticipantIds.forEach(pId => {
            const participant = ALL_PARTICIPANTS_FLAT.find(p => p.id === pId);
            if (!participant) return;
            
            count++;
            const isExcluded = excludedParticipantIds.has(pId);
            
            exclusionListEl.innerHTML += `
                <div class="flex items-center">
                    <input type="checkbox" id="ex-${pId}" data-action="exclude-participant" data-participant-id="${pId}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" ${isExcluded ? 'checked' : ''}>
                    <label for="ex-${pId}" class="ml-2 text-sm text-gray-700">${participant.name}</label>
                </div>
            `;
        });

        if (count === 0) {
            exclusionListEl.innerHTML = '<p class="text-sm text-gray-500">参加者が選択されていません。</p>';
        }
    }

    // ステップ5: 割り当て結果を描画
    function renderAssignmentResults() {
        assignmentResultsEl.innerHTML = '';
        textOutputEl.value = '';
        let outputLines = [];

        if (currentAssignments.size === 0) {
            assignmentResultsEl.innerHTML = '<p class="text-sm text-gray-500 col-span-full">まだ割り当てが実行されていません。</p>';
            return;
        }

        // 割り当てられた車を描画
        currentAssignments.forEach((assignment, carId) => {
            if (carId === 'c_excluded') return; // 別便は最後

            const carInfo = AVAILABLE_CARS_INFO.find(c => c.id === carId);
            const { driver, passengers, capacity, actualCapacity } = assignment;
            const passengerCount = passengers.length;
            const vacancy = actualCapacity - passengerCount;

            const carCard = document.createElement('div');
            carCard.className = 'bg-white rounded-lg shadow border border-gray-200 car-dropzone';
            carCard.dataset.carId = carId;

            // ドライバー欄
            const driverEl = document.createElement('div');
            driverEl.className = 'p-3 border-b-2 border-indigo-200 driver-dropzone';
            driverEl.dataset.carId = carId;
            driverEl.dataset.dropType = 'driver';

            let driverName = 'ドライバー未設定';
            let driverRemarks = '';
            if (driver) {
                driverEl.dataset.participantId = driver.id;
                driverEl.setAttribute('draggable', true);
                driverEl.dataset.dragType = 'driver';
                const flags = participantFlags.get(driver.id);
                driverRemarks = flags?.remarks ? ` (${flags.remarks})` : '';
                driverName = `${driver.name}${driverRemarks}`;
            }
            
            carCard.innerHTML = `
                <div class="p-3 bg-gray-100 rounded-t-lg">
                    <h3 class="font-bold text-lg text-gray-800">${carInfo.name}</h3>
                    <p class="text-sm text-gray-600">
                        ${assignment.hasLuggage ? '<span class="font-semibold text-red-600">[荷物あり]</span> ' : ''}
                        定員 ${capacity}名 (空き ${vacancy}名)
                    </p>
                </div>
            `;

            driverEl.innerHTML = `
                <span class="text-xs font-semibold text-indigo-700">ドライバー</span>
                <p class="font-semibold text-indigo-800" data-drag-handle="true">${driverName}</p>
            `;
            
            // 乗客リスト
            const passengerListEl = document.createElement('div');
            passengerListEl.className = 'p-3 space-y-2 car-assignment-list passenger-dropzone';
            passengerListEl.dataset.carId = carId;
            passengerListEl.dataset.dropType = 'passenger-list';
            
            passengers.forEach((p, index) => {
                const flags = participantFlags.get(p.id);
                const remarks = flags?.remarks ? ` (${flags.remarks})` : '';
                
                const pEl = document.createElement('div');
                pEl.className = 'p-2 bg-gray-50 rounded border border-gray-200 shadow-sm cursor-grab passenger-item';
                pEl.setAttribute('draggable', true);
                pEl.dataset.participantId = p.id;
                pEl.dataset.carId = carId;
                pEl.dataset.dragType = 'passenger';
                pEl.dataset.index = index;
                pEl.innerHTML = `<span data-drag-handle="true">${p.name}${remarks}</span> <span class="text-xs text-gray-500">(${p.type})</span>`;
                passengerListEl.appendChild(pEl);
            });
            
            carCard.appendChild(driverEl);
            carCard.appendChild(passengerListEl);
            assignmentResultsEl.appendChild(carCard);

            // テキスト出力用
            let line = `${carInfo.name}(${driver ? driver.name : '未設定'}`;
            if (assignment.hasLuggage) line += ', 荷物';
            passengers.forEach(p => {
                const flags = participantFlags.get(p.id);
                const remarks = flags?.remarks ? ` (${flags.remarks})` : '';
                line += `, ${p.name}${remarks}`;
            });
            line += ')';
            outputLines.push(line);
        });
        
        // 別便カーを描画
        const excludedAssignment = currentAssignments.get('c_excluded');
        if (excludedAssignment && excludedAssignment.passengers.length > 0) {
            const carCard = document.createElement('div');
            carCard.className = 'bg-white rounded-lg shadow border border-gray-200 car-dropzone';
            carCard.dataset.carId = 'c_excluded';

            carCard.innerHTML = `
                <div class="p-3 bg-gray-100 rounded-t-lg">
                    <h3 class="font-bold text-lg text-gray-800">別便カー</h3>
                    <p class="text-sm text-gray-600">
                        定員 ∞ (空き ∞)
                    </p>
                </div>
            `;
            
            // ドライバー欄 (ダミー)
            const driverEl = document.createElement('div');
            driverEl.className = 'p-3 border-b-2 border-gray-200 driver-dropzone';
            driverEl.dataset.carId = 'c_excluded';
            driverEl.dataset.dropType = 'driver';
            driverEl.innerHTML = `
                <span class="text-xs font-semibold text-gray-700">ドライバー</span>
                <p class="font-semibold text-gray-500">(なし)</p>
            `;
            
            // 乗客リスト
            const passengerListEl = document.createElement('div');
            passengerListEl.className = 'p-3 space-y-2 car-assignment-list passenger-dropzone';
            passengerListEl.dataset.carId = 'c_excluded';
            passengerListEl.dataset.dropType = 'passenger-list';
            
            excludedAssignment.passengers.forEach((p, index) => {
                const flags = participantFlags.get(p.id);
                const remarks = flags?.remarks ? ` (${flags.remarks})` : '';
                
                const pEl = document.createElement('div');
                pEl.className = 'p-2 bg-gray-50 rounded border border-gray-200 shadow-sm cursor-grab passenger-item';
                pEl.setAttribute('draggable', true);
                pEl.dataset.participantId = p.id;
                pEl.dataset.carId = 'c_excluded';
                pEl.dataset.dragType = 'passenger';
                pEl.dataset.index = index;
                pEl.innerHTML = `<span data-drag-handle="true">${p.name}${remarks}</span> <span class="text-xs text-gray-500">(${p.type})</span>`;
                passengerListEl.appendChild(pEl);
            });

            carCard.appendChild(driverEl);
            carCard.appendChild(passengerListEl);
            assignmentResultsEl.appendChild(carCard);
        }

        // テキスト出力
        textOutputEl.value = outputLines.join('\n');
    }
    
    // --- 割り当てロジック ---

    function handleAssignment() {
        // 1. バリデーション
        if (selectedCarIds.size === 0) {
            showMessage('車が選択されていません。', 'error');
            return;
        }

        let totalCapacity = 0;
        const assignments = new Map();
        let validationError = false;

        selectedCarIds.forEach(carId => {
            const carInfo = AVAILABLE_CARS_INFO.find(c => c.id === carId);
            const settings = carSettings.get(carId);

            if (!settings.driverId) {
                showMessage(`${carInfo.name} のドライバーが選択されていません。`, 'error');
                validationError = true;
                return;
            }

            if (!selectedParticipantIds.has(settings.driverId) || excludedParticipantIds.has(settings.driverId)) {
                const driver = ALL_PARTICIPANTS_FLAT.find(p => p.id === settings.driverId);
                showMessage(`${carInfo.name} のドライバー (${driver.name}) が参加者として選択されていないか、別便になっています。`, 'error');
                validationError = true;
                return;
            }

            const driver = ALL_PARTICIPANTS_FLAT.find(p => p.id === settings.driverId);
            const capacity = carInfo.capacity;
            let actualCapacity = 0;
            
            if (settings.hasLuggage) {
                actualCapacity = 1; // 荷物ありの場合、乗客は1名のみ
            } else {
                actualCapacity = capacity - 1; // ドライバー分を引く
            }

            totalCapacity += actualCapacity;
            assignments.set(carId, {
                driver: driver,
                passengers: [],
                capacity: capacity, // 元の定員
                actualCapacity: actualCapacity, // 実質の乗客定員
                hasLuggage: settings.hasLuggage
            });
        });

        if (validationError) return;
        
        // 別便カーの準備
        const excludedPassengers = [];
        excludedParticipantIds.forEach(pId => {
            if (selectedParticipantIds.has(pId)) {
                excludedPassengers.push(getParticipantWithFlags(pId));
            }
        });
        assignments.set('c_excluded', {
            driver: null,
            passengers: excludedPassengers,
            capacity: Infinity,
            actualCapacity: Infinity,
            hasLuggage: false
        });

        // 2. 割り当て対象の乗客リストを作成
        let participantsToAssign = [];
        selectedParticipantIds.forEach(pId => {
            // ドライバーでもなく、別便でもない人
            const isDriver = Array.from(assignments.values()).some(a => a.driver?.id === pId);
            if (!isDriver && !excludedParticipantIds.has(pId)) {
                participantsToAssign.push(getParticipantWithFlags(pId));
            }
        });

        if (participantsToAssign.length > totalCapacity) {
            showMessage(`定員オーバーです。参加者 ${participantsToAssign.length} 人に対し、車の乗客定員は合計 ${totalCapacity} 人です。`, 'error');
            return;
        }

        // 3. 割り当て実行
        try {
            const finalAssignments = allocateParticipants(participantsToAssign, assignments);
            currentAssignments = finalAssignments;
            
            // 4. 結果描画
            renderAssignmentResults();
            showMessage('割り当てを実行しました。', 'success');
            
            // 5. D&Dイベントリスナーを設定
            setupDragAndDrop();
            
        } catch (error) {
            console.error("割り当てロジックでエラー:", error);
            showMessage(`割り当て中にエラーが発生しました: ${error.message}`, 'error');
        }
    }
    
    function getParticipantWithFlags(pId) {
        const participant = ALL_PARTICIPANTS_FLAT.find(p => p.id === pId);
        const flags = participantFlags.get(pId);
        return { ...participant, flags: flags };
    }
    
    // 参加者オブジェクトの優先順位を返す (低いほど優先)
    function getParticipantPriority(participant) {
        if (participant.type === '保護者') return 1;
        if (participant.type === '兄弟') return 2;
        if (participant.type === '選手') return 3;
        return 4; // その他
    }

    // 割り当てロジック本体
    function allocateParticipants(participants, assignments) {
        let remainingParticipants = [...participants];

        // --- 最優先: 自分の家族の車に乗る ---
        const assignedInStep1 = new Set();
        assignments.forEach((assignment, carId) => {
            if (!assignment.driver || carId === 'c_excluded') return;
            
            const driverFamilyName = assignment.driver.familyName;
            
            // この車に乗るべき家族メンバーを抽出 (ドライバー自身は除く)
            const familyMembersToAssign = remainingParticipants
                .filter(p => p.familyName === driverFamilyName && p.id !== assignment.driver.id)
                .sort((a, b) => getParticipantPriority(a) - getParticipantPriority(b)); // 保護者 > 兄弟 > 選手

            familyMembersToAssign.forEach(member => {
                if (assignment.passengers.length < assignment.actualCapacity) {
                    assignment.passengers.push(member);
                    assignedInStep1.add(member.id);
                }
            });
        });
        
        // ステップ1で割り当て済みの参加者を除外
        remainingParticipants = remainingParticipants.filter(p => !assignedInStep1.has(p.id));
        
        // --- 次優先: フラグ一致 ---
        const assignedInStep2 = new Set();
        
        // フラグが設定されている参加者のみ
        let flagParticipants = remainingParticipants.filter(p => 
            p.flags && (p.flags.grade || p.flags.school || p.flags.other)
        );
        
        // ランダムシャッフルして順序による偏りをなくす
        flagParticipants.sort(() => Math.random() - 0.5);

        flagParticipants.forEach(participant => {
            let bestCarId = null;
            let maxScore = -1; // 0点(一致なし)は後回しにするため-1から
            let bestCarCandidates = []; // 最高スコアが同じ車

            assignments.forEach((assignment, carId) => {
                if (carId === 'c_excluded' || assignment.passengers.length >= assignment.actualCapacity) {
                    return; // 別便または満席
                }
                
                let currentScore = 0;
                // 現在の乗客と比較してスコア計算
                assignment.passengers.forEach(passenger => {
                    if (participant.flags.grade && passenger.flags.grade === participant.flags.grade) currentScore++;
                    if (participant.flags.school && passenger.flags.school === participant.flags.school) currentScore++;
                    if (participant.flags.other && passenger.flags.other === participant.flags.other) currentScore++;
                });

                if (currentScore > maxScore) {
                    maxScore = currentScore;
                    bestCarCandidates = [carId];
                } else if (currentScore === maxScore) {
                    bestCarCandidates.push(carId);
                }
            });

            if (maxScore > 0 && bestCarCandidates.length > 0) {
                // 最高スコアの車候補からランダムで選択
                bestCarId = bestCarCandidates[Math.floor(Math.random() * bestCarCandidates.length)];
                assignments.get(bestCarId).passengers.push(participant);
                assignedInStep2.add(participant.id);
            }
        });
        
        // ステップ2で割り当て済みの参加者を除外
        remainingParticipants = remainingParticipants.filter(p => !assignedInStep1.has(p.id) && !assignedInStep2.has(p.id));

        // --- 残り: 個人 (ラウンドロビン) ---
        if (remainingParticipants.length > 0) {
            let carIds = Array.from(assignments.keys()).filter(id => id !== 'c_excluded');
            let carIndex = 0;
            
            remainingParticipants.forEach(participant => {
                let assigned = false;
                let attemptCount = 0;
                
                while (!assigned && attemptCount < carIds.length) {
                    const carId = carIds[carIndex];
                    const assignment = assignments.get(carId);
                    
                    if (assignment.passengers.length < assignment.actualCapacity) {
                        assignment.passengers.push(participant);
                        assigned = true;
                    }
                    
                    carIndex = (carIndex + 1) % carIds.length;
                    attemptCount++;
                }
                
                if (!assigned) {
                    // 予期せぬエラー：満席のはずだが...
                    console.warn("空きがあるはずの車に割り当てられませんでした:", participant);
                    // どこでもいいから空いてる車にねじ込む
                    const firstAvailableCar = Array.from(assignments.values()).find(a => a.passengers.length < a.actualCapacity);
                    if (firstAvailableCar) {
                        firstAvailableCar.passengers.push(participant);
                    }
                }
            });
        }

        return assignments;
    }


    // --- D&D と タッチ操作 ---
    
    function setupDragAndDrop() {
        const containers = assignmentResultsEl.querySelectorAll('.car-dropzone');
        containers.forEach(container => {
            // 標準D&D
            container.addEventListener('dragstart', handleDragStart, false);
            container.addEventListener('dragenter', handleDragEnter, false);
            container.addEventListener('dragover', handleDragOver, false);
            container.addEventListener('dragleave', handleDragLeave, false);
            container.addEventListener('drop', handleDrop, false);
            container.addEventListener('dragend', handleDragEnd, false);
            
            // タッチ操作
            container.addEventListener('touchstart', handleTouchStart, { passive: false });
            container.addEventListener('touchmove', handleTouchMove, { passive: false });
            container.addEventListener('touchend', handleTouchEnd, false);
            container.addEventListener('touchcancel', handleTouchEnd, false);
        });
    }

    // --- 標準 D&D ハンドラ ---
    
    function handleDragStart(e) {
        // ドラッグハンドル (名前部分) からドラッグ開始されたかチェック
        const handle = e.target.closest('[data-drag-handle="true"]');
        if (!handle) {
            e.preventDefault();
            return;
        }

        const target = handle.closest('[draggable="true"]');
        if (!target) {
            e.preventDefault();
            return;
        }
        
        draggedElement = target;
        const type = target.dataset.dragType; // 'driver' or 'passenger'
        const id = target.dataset.participantId;
        const fromCar = target.closest('.car-dropzone').dataset.carId;
        
        draggedData = { type, id, fromCar };
        
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', JSON.stringify(draggedData));
        
        // 少し遅れてゴーストを非表示化
        setTimeout(() => {
            if (draggedElement) { // dragendでnullになることがある
                draggedElement.style.opacity = '0.4';
            }
        }, 0);
    }

    function handleDragEnter(e) {
        e.preventDefault(); // dragoverでやるので不要かも
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';

        clearHighlights();
        
        const target = e.target;
        const dropZone = target.closest('.driver-dropzone, .passenger-item, .passenger-dropzone');
        
        if (!dropZone) return;

        const targetCarId = dropZone.closest('.car-dropzone').dataset.carId;
        
        // 1. ドライバー欄へのドロップ (入れ替え)
        if (dropZone.classList.contains('driver-dropzone')) {
            dropZone.classList.add('drag-over-border');
        }
        // 2. 乗客アイテムへのドロップ (挿入)
        else if (dropZone.classList.contains('passenger-item')) {
            // 自分自身の上はハイライトしない
            if (draggedElement && draggedElement === dropZone) return; 
            
            const rect = dropZone.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            if (e.clientY < midY) {
                dropZone.classList.add('drag-over-insert-before');
            } else {
                dropZone.classList.add('drag-over-insert-after');
            }
        }
        // 3. 乗客リストの背景へのドロップ (末尾に移動)
        else if (dropZone.classList.contains('passenger-dropzone')) {
            dropZone.classList.add('drag-over-bg');
        }
    }

    function handleDragLeave(e) {
        // ハイライト消去はdragoverでまとめてやる
    }

    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (!draggedElement) return;

        const target = e.target;
        const dropZone = target.closest('.driver-dropzone, .passenger-item, .passenger-dropzone');
        
        if (!dropZone) {
            cleanupDrag();
            return;
        }

        const targetCarId = dropZone.closest('.car-dropzone').dataset.carId;
        
        // ドロップ操作を実行
        performDropOperation(targetCarId, dropZone);
        cleanupDrag();
    }
    
    function handleDragEnd(e) {
        cleanupDrag();
    }
    
    function cleanupDrag() {
        if (draggedElement) {
            draggedElement.style.opacity = '1';
        }
        draggedElement = null;
        draggedData = null;
        clearHighlights();
    }

    // --- タッチ操作ハンドラ ---
    
    function handleTouchStart(e) {
        // ドラッグハンドル (名前部分) 以外は無視
        const handle = e.target.closest('[data-drag-handle="true"]');
        if (!handle) {
            clearTimeout(longPressTimer);
            return;
        }

        // 長押しでドラッグ開始
        longPressTimer = setTimeout(() => {
            longPressTimer = null;
            
            const target = handle.closest('[draggable="true"]');
            if (!target) return;
            
            // 既存のゴーストがあれば削除
            if (touchGhost) touchGhost.remove();

            draggedElement = target;
            const type = target.dataset.dragType;
            const id = target.dataset.participantId;
            const fromCar = target.closest('.car-dropzone').dataset.carId;
            
            draggedData = { type, id, fromCar };

            // ゴースト要素作成
            touchGhost = draggedElement.cloneNode(true);
            touchGhost.classList.add('touch-ghost');
            document.body.appendChild(touchGhost);
            
            // ゴーストの位置を更新
            const touch = e.touches[0];
            updateTouchGhostPosition(touch.clientX, touch.clientY);
            
            // 元の要素を非表示化
            draggedElement.style.opacity = '0.4';
            
            // スクロールやテキスト選択を防止
            // e.preventDefault(); // ここで呼ぶとクリックイベントが死ぬ
            
        }, 300); // 300msの長押しでドラッグ開始
        
        e.preventDefault(); // 画面スクロールを一旦止める
    }

    function handleTouchMove(e) {
        // ドラッグが開始されていなければ何もしない
        if (!draggedElement || !draggedData || !touchGhost) {
            // 長押し前に指が動いたらタイマーキャンセル
            clearTimeout(longPressTimer);
            return;
        }

        // スクロールを防止
        e.preventDefault();
        
        const touch = e.touches[0];
        
        // 1. ゴーストを移動
        updateTouchGhostPosition(touch.clientX, touch.clientY);

        // 2. 指の下の要素をハイライト (dragover相当)
        clearHighlights();
        
        // ゴーストを一時的に隠して、指の下の要素を取得
        touchGhost.style.display = 'none';
        const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
        touchGhost.style.display = ''; // すぐ戻す
        
        if (!elementUnderTouch) return;

        const dropZone = elementUnderTouch.closest('.driver-dropzone, .passenger-item, .passenger-dropzone');
        if (!dropZone) return;
        
        // dragoverと同じロジック
        if (dropZone.classList.contains('driver-dropzone')) {
            dropZone.classList.add('drag-over-border');
        }
        else if (dropZone.classList.contains('passenger-item')) {
            // 自分自身の上はハイライトしない
            if (draggedElement && draggedElement === dropZone) return; 

            const rect = dropZone.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            if (touch.clientY < midY) {
                dropZone.classList.add('drag-over-insert-before');
            } else {
                dropZone.classList.add('drag-over-insert-after');
            }
        }
        else if (dropZone.classList.contains('passenger-dropzone')) {
            dropZone.classList.add('drag-over-bg');
        }
    }
    
    function handleTouchEnd(e) {
        clearTimeout(longPressTimer); // タイマーキャンセル
        
        // ドラッグが開始されていなければ何もしない (通常のタップ/クリックとして処理される)
        if (!draggedElement || !draggedData || !touchGhost) {
            cleanupTouch();
            return;
        }

        // e.preventDefault(); // リンク遷移などを防ぐ
        
        // 指が離れた位置の要素を取得 (drop相当)
        const touch = e.changedTouches[0];
        
        // ゴーストを一時的に隠して、指の下の要素を取得
        touchGhost.style.display = 'none';
        const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
        touchGhost.style.display = ''; // すぐ戻す (cleanupで消える)
        
        if (elementUnderTouch) {
            const dropZone = elementUnderTouch.closest('.driver-dropzone, .passenger-item, .passenger-dropzone');
            
            if (dropZone) {
                // 自分自身にドロップした場合は何もしない
                if (draggedElement && draggedElement === dropZone) {
                    // 何もしない
                } else {
                    const targetCarId = dropZone.closest('.car-dropzone').dataset.carId;
                    performDropOperation(targetCarId, dropZone);
                }
            }
        }
        
        cleanupTouch();
    }
    
    function cleanupTouch() {
        if (touchGhost) {
            touchGhost.remove();
            touchGhost = null;
        }
        if (draggedElement) {
            draggedElement.style.opacity = '1';
        }
        draggedElement = null;
        draggedData = null;
        clearHighlights();
    }
    
    function updateTouchGhostPosition(x, y) {
        if (touchGhost) {
            touchGhost.style.left = `${x}px`;
            touchGhost.style.top = `${y}px`;
        }
    }


    // --- 共通 D&D コアロジック ---

    function clearHighlights() {
        document.querySelectorAll('.drag-over-bg, .drag-over-border, .drag-over-insert-before, .drag-over-insert-after')
            .forEach(el => el.classList.remove('drag-over-bg', 'drag-over-border', 'drag-over-insert-before', 'drag-over-insert-after'));
    }
    
    // データ操作とUI再描画
    function performDropOperation(targetCarId, dropZoneElement) {
        if (!draggedData || !targetCarId) return;

        const { type: dragType, id: dragId, fromCar: fromCarId } = draggedData;
        
        // 自分自身にドロップ
        if (draggedElement && draggedElement === dropZoneElement) {
            return; 
        }
        
        const fromAssignment = currentAssignments.get(fromCarId);
        const toAssignment = currentAssignments.get(targetCarId);
        
        const dragParticipant = (dragType === 'driver')
            ? fromAssignment.driver
            : fromAssignment.passengers.find(p => p.id === dragId);
            
        if (!dragParticipant) {
            console.error("ドラッグ対象の参加者が見つかりません");
            return;
        }

        // 操作タイプを決定
        let operationType = 'move-to-list-end'; // デフォルト
        let targetParticipantId = null;
        let insertBefore = false;

        if (dropZoneElement.classList.contains('driver-dropzone')) {
            operationType = 'swap-driver';
        } else if (dropZoneElement.classList.contains('passenger-item')) {
            operationType = 'insert-before'; // デフォルトは前に挿入
            targetParticipantId = dropZoneElement.dataset.participantId;
            if (dropZoneElement.classList.contains('drag-over-insert-after')) {
                operationType = 'insert-after';
            }
        }
        
        // --- 定員チェック ---
        if (fromCarId !== targetCarId && operationType !== 'swap-driver') {
            // 他の車への「移動」または「挿入」の場合のみ
            if (toAssignment.passengers.length >= toAssignment.actualCapacity) {
                // 「別便カー」以外は定員チェック
                if (targetCarId !== 'c_excluded') {
                    showMessage('移動先の車の定員がオーバーしています。', 'error');
                    return;
                }
            }
        }

        // --- データ操作 ---
        
        // 1. 元の場所から削除
        if (dragType === 'driver') {
            fromAssignment.driver = null; // ドライバー削除
        } else {
            fromAssignment.passengers = fromAssignment.passengers.filter(p => p.id !== dragId);
        }

        // 2. 新しい場所に配置
        try {
            switch (operationType) {
                case 'swap-driver':
                    const existingDriver = toAssignment.driver;
                    toAssignment.driver = dragParticipant;
                    
                    // 元の車がドライバー欄だった場合、入れ替え
                    if (dragType === 'driver') {
                        if (existingDriver) {
                            fromAssignment.driver = existingDriver;
                        }
                    } 
                    // 元が乗客だった場合、入れ替え
                    else {
                        if (existingDriver) {
                            // 定員チェック
                            if (fromAssignment.passengers.length >= fromAssignment.actualCapacity && fromCarId !== 'c_excluded') {
                                showMessage('元の車が定員オーバーになるため、ドライバーと入れ替えできません。', 'error');
                                // 元に戻す
                                fromAssignment.passengers.push(dragParticipant); 
                                toAssignment.driver = existingDriver;
                                return;
                            }
                            fromAssignment.passengers.push(existingDriver);
                        }
                    }
                    break;
                
                case 'insert-before':
                case 'insert-after':
                    const targetIndex = toAssignment.passengers.findIndex(p => p.id === targetParticipantId);
                    if (targetIndex > -1) {
                        const insertIndex = (operationType === 'insert-before') ? targetIndex : targetIndex + 1;
                        toAssignment.passengers.splice(insertIndex, 0, dragParticipant);
                    } else {
                        // 対象が見つからない場合、末尾に追加
                        toAssignment.passengers.push(dragParticipant);
                    }
                    break;
                    
                case 'move-to-list-end':
                default:
                    toAssignment.passengers.push(dragParticipant);
                    break;
            }
        } catch (e) {
            console.error("Drop操作エラー:", e);
            showMessage("操作に失敗しました。", "error");
            // TODO: ロールバック処理
            return;
        }

        // 3. UI再描画
        renderAssignmentResults();
        setupDragAndDrop(); // 再描画したのでリスナー再設定
    }


    // --- イベントハンドラ ---

    // 家族一括選択ハンドラ
    function handleParticipantFamilyClick(e) {
        const target = e.target.closest('button');
        if (!target) return;

        const action = target.dataset.action;
        const familyName = target.dataset.familyName;

        if (!familyName || (action !== 'family-select-all' && action !== 'family-select-none')) {
            return;
        }

        e.preventDefault(); // detailsの開閉をキャンセル
        e.stopPropagation(); // イベント伝播を停止

        const family = FAMILIES.find(f => f.familyName === familyName);
        if (!family) return;

        const shouldSelect = action === 'family-select-all';

        family.members.forEach(p => {
            const checkbox = document.getElementById(`p-${p.id}`);
            const dataEl = document.getElementById(`data-inputs-${p.id}`);
            
            if (shouldSelect) {
                selectedParticipantIds.add(p.id);
                if (checkbox) checkbox.checked = true;
                if (dataEl) {
                    dataEl.classList.remove('opacity-50');
                    dataEl.querySelectorAll('input, textarea').forEach(input => input.disabled = false);
                }
            } else {
                selectedParticipantIds.delete(p.id);
                excludedParticipantIds.delete(p.id); // 除外リストからも削除
                if (checkbox) checkbox.checked = false;
                if (dataEl) {
                    dataEl.classList.add('opacity-50');
                    dataEl.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                }
            }
        });

        renderExclusionList(); // 除外リストを即時更新
    }

    function handleParticipantChange(e) {
        const target = e.target;
        if (target.type === 'checkbox' && target.dataset.action === 'select-participant') {
            const pId = target.dataset.participantId;
            const dataEl = document.getElementById(`data-inputs-${pId}`);
            
            if (target.checked) {
                selectedParticipantIds.add(pId);
                if (dataEl) {
                    dataEl.classList.remove('opacity-50');
                    dataEl.querySelectorAll('input, textarea').forEach(input => input.disabled = false);
                }
            } else {
                selectedParticipantIds.delete(pId);
                excludedParticipantIds.delete(pId); // 除外リストからも削除
                if (dataEl) {
                    dataEl.classList.add('opacity-50');
                    dataEl.querySelectorAll('input, textarea').forEach(input => input.disabled = true);
                }
            }
            renderExclusionList();
        }
    }
    
    function handleParticipantDataInput(e) {
        const target = e.target;
        const pId = target.dataset.participantId;
        const field = target.dataset.field;
        
        if (pId && field) {
            const flags = participantFlags.get(pId);
            if (flags) {
                flags[field] = target.value;
            }
        }
    }

    function handleCarChange(e) {
        const target = e.target;
        const carId = target.dataset.carId;
        const field = target.dataset.field;
        
        if (target.type === 'checkbox' && target.dataset.action === 'select-car') {
            const inputs = target.closest('.border').querySelectorAll('select, input[type="checkbox"][data-field]');
            if (target.checked) {
                selectedCarIds.add(carId);
                target.closest('.border').classList.add('bg-blue-50');
                target.closest('.border').classList.remove('bg-gray-50');
                inputs.forEach(input => input.disabled = false);
                target.closest('.border').querySelector('.pl-8').classList.remove('opacity-50');
            } else {
                selectedCarIds.delete(carId);
                target.closest('.border').classList.remove('bg-blue-50');
                target.closest('.border').classList.add('bg-gray-50');
                inputs.forEach(input => input.disabled = true);
                target.closest('.border').querySelector('.pl-8').classList.add('opacity-50');
            }
        }
        else if (carId && field) {
            const settings = carSettings.get(carId);
            if (settings) {
                if (target.type === 'checkbox') {
                    settings[field] = target.checked;
                } else {
                    settings[field] = target.value;
                }
            }
        }
    }

    function handleExclusionChange(e) {
        const target = e.target;
        if (target.type === 'checkbox' && target.dataset.action === 'exclude-participant') {
            const pId = target.dataset.participantId;
            if (target.checked) {
                excludedParticipantIds.add(pId);
            } else {
                excludedParticipantIds.delete(pId);
            }
        }
    }
    
    function handleToggleAllParticipants() {
        const allDetails = participantListEl.querySelectorAll('details');
        // 最初のdetailsが開いているかどうかに基づいて、すべてをその逆に設定
        const shouldOpen = allDetails.length > 0 ? !allDetails[0].open : true;
        allDetails.forEach(details => details.open = shouldOpen);
        toggleAllParticipantsBtn.textContent = shouldOpen ? 'すべて閉じる' : 'すべて開く';
    }


    // --- ユーティリティ ---

    function showMessage(message, type = 'success') {
        messageText.textContent = message;
        
        // Remove old classes
        messageBox.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500');
        
        if (type === 'success') {
            messageBox.classList.add('bg-green-500');
        } else if (type === 'error') {
            messageBox.classList.add('bg-red-500');
        } else {
            messageBox.classList.add('bg-yellow-500');
        }
        
        messageBox.classList.add('show');
        
        setTimeout(() => {
            messageBox.classList.remove('show');
        }, 3000);
    }
    
    function legacyCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';  // 見えないように
        textArea.style.top = '-9999px';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showMessage('テキストをコピーしました。', 'success');
            } else {
                showMessage('コピーに失敗しました。', 'error');
            }
        } catch (err) {
            showMessage('コピーに失敗しました。', 'error');
        }
        document.body.removeChild(textArea);
    }

    // --- インポート/エクスポート ---
    
    function handleExportState() {
        const state = {
            selectedParticipantIds: Array.from(selectedParticipantIds),
            selectedCarIds: Array.from(selectedCarIds),
            excludedParticipantIds: Array.from(excludedParticipantIds),
            participantFlags: Array.from(participantFlags.entries()),
            carSettings: Array.from(carSettings.entries()),
            currentAssignments: Array.from(currentAssignments.entries())
        };
        
        const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'car_assignment_state.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    function handleImportState(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const state = JSON.parse(event.target.result);
                
                selectedParticipantIds = new Set(state.selectedParticipantIds || []);
                selectedCarIds = new Set(state.selectedCarIds || []);
                excludedParticipantIds = new Set(state.excludedParticipantIds || []);
                participantFlags = new Map(state.participantFlags || []);
                carSettings = new Map(state.carSettings || []);
                currentAssignments = new Map(state.currentAssignments || []);

                // 読み込んだデータでUIを再描画
                renderParticipantList();
                renderCarList();
                renderExclusionList();
                renderAssignmentResults();
                setupDragAndDrop();
                
                showMessage('状態を読み込みました。', 'success');
            } catch (err) {
                console.error("状態の読み込みに失敗:", err);
                showMessage('状態ファイルの読み込みに失敗しました。', 'error');
            } finally {
                // 同じファイルを選択しても再度changeイベントが発火するように
                e.target.value = null;
            }
        };
        reader.readAsText(file);
    }
    
    function handleExportMaster() {
        const master = {
            FAMILIES,
            AVAILABLE_CARS_INFO
        };
        const blob = new Blob([JSON.stringify(master, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'car_assignment_master.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function handleImportMaster(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const master = JSON.parse(event.target.result);
                
                if (!master.FAMILIES || !master.AVAILABLE_CARS_INFO) {
                    throw new Error("マスターデータの形式が正しくありません。");
                }
                
                // マスターデータを上書き
                FAMILIES = master.FAMILIES;
                AVAILABLE_CARS_INFO = master.AVAILABLE_CARS_INFO;

                // 状態をすべてリセット
                selectedParticipantIds.clear();
                selectedCarIds.clear();
                excludedParticipantIds.clear();
                currentAssignments.clear();

                // 関連データを再初期化
                initializeParticipantData();
                initializeDefaultDrivers();
                
                // UIを再描画
                renderParticipantList();
                renderCarList();
                renderExclusionList();
                renderAssignmentResults(); // クリアされる
                
                // アコーディオンボタンのテキストをリセット
                toggleAllParticipantsBtn.textContent = 'すべて閉じる';

                showMessage('マスターデータを読み込み、アプリをリセットしました。', 'success');
                
            } catch (err) {
                console.error("マスターの読み込みに失敗:", err);
                showMessage(`マスターファイルの読み込みに失敗しました: ${err.message}`, 'error');
            } finally {
                e.target.value = null;
            }
        };
        reader.readAsText(file);
    }


    // --- イベントリスナー設定 ---
    document.addEventListener('DOMContentLoaded', () => {
        // マスターデータ初期化
        setDefaultMasterData();
        initializeParticipantData();
        initializeDefaultDrivers();
        
        // レイアウト設定
        setLayoutColumns();
        
        // 初期描画
        renderParticipantList();
        renderCarList();
        renderExclusionList();
        renderAssignmentResults();

        // イベントリスナー
        participantListEl.addEventListener('change', handleParticipantChange);
        participantListEl.addEventListener('input', handleParticipantDataInput); 
        participantListEl.addEventListener('click', handleParticipantFamilyClick); // 家族一括選択リスナー
        carListEl.addEventListener('change', handleCarChange);
        exclusionListEl.addEventListener('change', handleExclusionChange);
        assignButton.addEventListener('click', handleAssignment);
        toggleAllParticipantsBtn.addEventListener('click', handleToggleAllParticipants);
        
        copyTextBtn.addEventListener('click', () => legacyCopy(textOutputEl.value));
        
        exportStateBtn.addEventListener('click', handleExportState);
        importStateInput.addEventListener('change', handleImportState);
        exportMasterBtn.addEventListener('click', handleExportMaster);
        importMasterInput.addEventListener('change', handleImportMaster);
    });

</script>
</body>
</html>


